<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Find features with high spatial autocorrelation — CorSpatialFeatures • semla</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Find features with high spatial autocorrelation — CorSpatialFeatures"><meta name="description" content="This function can be used to find genes with high spatial autocorrelation in SRT data.
A more detailed description of the algorithm is outlined below."><meta property="og:description" content="This function can be used to find genes with high spatial autocorrelation in SRT data.
A more detailed description of the algorithm is outlined below."><meta property="og:image" content="https://ludvigla.github.io/semla/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">semla</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/semla.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials"><li><h6 class="dropdown-header" data-toc-skip>Intro</h6></li>
    <li><a class="dropdown-item" href="../articles/getting_started.html">Get started</a></li>
    <li><a class="dropdown-item" href="../articles/subset_and_merge.html">Subset/merge</a></li>
    <li><a class="dropdown-item" href="../articles/visiumHD.html">VisiumHD</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Spatial visualization</h6></li>
    <li><a class="dropdown-item" href="../articles/numeric_features.html">Map numeric features</a></li>
    <li><a class="dropdown-item" href="../articles/categorical_features.html">Map categorical features</a></li>
    <li><a class="dropdown-item" href="../articles/advanced_visualization.html">Advanced visualization</a></li>
    <li><a class="dropdown-item" href="../articles/feature_viewer.html">Feature viewer</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Spatial methods</h6></li>
    <li><a class="dropdown-item" href="../articles/radial_distances.html">Radial distances</a></li>
    <li><a class="dropdown-item" href="../articles/region_neighbors.html">Region neighbors</a></li>
    <li><a class="dropdown-item" href="../articles/spatial_statistics_for_labelled_spots.html">Statistics for labelled spots</a></li>
    <li><a class="dropdown-item" href="../articles/spatial_autocorrelation.html">Spatial autocorrelation</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Analysis</h6></li>
    <li><a class="dropdown-item" href="../articles/cell_type_mapping_with_NNLS.html">Cell type mapping</a></li>
    <li><a class="dropdown-item" href="../articles/digital_unrolling.html">Digital unrolling</a></li>
    <li><a class="dropdown-item" href="../articles/NNMF.html">Non-negative Matrix Factorization</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Image processing</h6></li>
    <li><a class="dropdown-item" href="../articles/images_and_coordinates.html">Images and spot coordinates</a></li>
    <li><a class="dropdown-item" href="../articles/mask_images.html">Image masking</a></li>
    <li><a class="dropdown-item" href="../articles/image_alignment.html">Image alignment</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/create_object.html">Create a Staffli object</a></li>
    <li><a class="dropdown-item" href="../articles/compare_cell_type_mapping_NNLS.html">Cell type mapping comparison</a></li>
    <li><a class="dropdown-item" href="../articles/cell_type_mapping_benchmark.html">Cell type mapping benchmark</a></li>
    <li><a class="dropdown-item" href="../articles/slide-seq.html">Slide-Seq data</a></li>
    <li><a class="dropdown-item" href="../articles/IF_data.html">IF data</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ludvigla/semla" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Find features with high spatial autocorrelation</h1>

      <div class="d-none name"><code>cor-features.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function can be used to find genes with high spatial autocorrelation in SRT data.
A more detailed description of the algorithm is outlined below.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">CorSpatialFeatures</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Default S3 method</span></span>
<span><span class="fu">CorSpatialFeatures</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  <span class="va">spatnet</span>,</span>
<span>  across_all <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  calculate_pvalue <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  nCores <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'Seurat'</span></span>
<span><span class="fu">CorSpatialFeatures</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  features <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  assay_use <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  slot_use <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>  across_all <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  calculate_pvalue <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  nCores <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>An object (see details)</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Arguments passed to other methods</p></dd>


<dt id="arg-spatnet">spatnet<a class="anchor" aria-label="anchor" href="#arg-spatnet"></a></dt>
<dd><p>A list of spatial networks created with <code><a href="get-network.html">GetSpatialNetwork</a></code>. The spots in these
networks should match the spots in the feature matrix.</p></dd>


<dt id="arg-across-all">across_all<a class="anchor" aria-label="anchor" href="#arg-across-all"></a></dt>
<dd><p>Boolean specifying if autocorrelation scores be calculated across all samples (default
FALSE).</p></dd>


<dt id="arg-calculate-pvalue">calculate_pvalue<a class="anchor" aria-label="anchor" href="#arg-calculate-pvalue"></a></dt>
<dd><p>Boolean specifying if p-values should be calculated for each correlation value
(default FALSE). Raw and BH-adjusted p-values provided.</p></dd>


<dt id="arg-ncores">nCores<a class="anchor" aria-label="anchor" href="#arg-ncores"></a></dt>
<dd><p>Number of cores to use for the spatial autocorrelation calculation</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Print messages</p></dd>


<dt id="arg-features">features<a class="anchor" aria-label="anchor" href="#arg-features"></a></dt>
<dd><p>A character vector with features present in <code>Seurat</code> object. These
features need to be accessible with <code><a href="https://rdrr.io/pkg/SeuratObject/man/FetchData.html" class="external-link">FetchData</a></code></p></dd>


<dt id="arg-assay-use">assay_use<a class="anchor" aria-label="anchor" href="#arg-assay-use"></a></dt>
<dd><p>Select assay to use for computation. If not specified, the default
assay will be used.</p></dd>


<dt id="arg-slot-use">slot_use<a class="anchor" aria-label="anchor" href="#arg-slot-use"></a></dt>
<dd><p>Select slot to use from assay object.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Either a list of tibbles or a tibble with feature names and correlation
scores. See section <strong>Mode</strong> for details.</p>
    </div>
    <div class="section level2">
    <h2 id="spatial-autocorrelation">Spatial autocorrelation<a class="anchor" aria-label="anchor" href="#spatial-autocorrelation"></a></h2>


<p>Spatial autocorrelation is the term used to describe the presence of systematic spatial
variation. Positive spatial autocorrelation of a feature is the tendency for regions that
are close together in space to have similar values for that feature.</p>
<p>A simple example is when you have an anatomical structure or a tissue type that spans
across multiple neighboring spots in an SRT experiment, for example a gland, an immune
infiltrate or a region of the brain. Inside such structures, you might find that the
expression levels of certain genes (or other features) are highly similar and hence
these genes have a positive spatial autocorrelation.</p>
<p>The method provided in <code>semla</code> works as follows. For each feature and spot,
the expression is averaged across all neighboring spots (typically the 6 closest neighbors)
to produce a lag expression vector. Since this vector represents the average of the surrounding
spots, we can use it to test if the expression in those spots is similar to the center spot.
One simple strategy is to calculate the pearson correlation between a genes' lag vector and
the original expression vector which typically captures the spatial autocorrelation well.</p>
    </div>
    <div class="section level2">
    <h2 id="method-steps">Method steps<a class="anchor" aria-label="anchor" href="#method-steps"></a></h2>


<ul><li><p>Load a matrix with features in rows and spots in columns: \(X_{expr}\)</p></li>
<li><p>Convert the corresponding spatial network to wide format and construct a nearest
neighbor matrix \(N_{neighbors}\) in which neighboring spots have a value of 1
and the remaining spots have a value of 0</p></li>
<li><p>\(N_{neighbors}\) is then multiplied with the \(X_{expr}\) to
calculate a lag vector for each feature: <br><br>
\(X_{lagexpr} = (N_{neighbors}*X_{expr})/n_{neighbors}\) <br><br>
where \(n_{neighbors}\) is the number of neighbors for each spot.</p></li>
<li><p>The spatial autocorrelation score for a feature is the 'pearson' correlation of the
lag vector and the initial expression vector: <br><br>
\(spatcor_{feature} = cor(X_{lagexpr}[feature, ], X_{expr}[feature, ])\)</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="default-method">Default method<a class="anchor" aria-label="anchor" href="#default-method"></a></h2>


<p>The default method expects a matrix-like object with features in columns and spots in rows
and a list of spatial networks generated with <code><a href="get-network.html">GetSpatialNetwork</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="mode">Mode<a class="anchor" aria-label="anchor" href="#mode"></a></h2>


<p>If <code>across_all</code> is set to <code>TRUE</code>, the spatial autocorrelation scores will be computed
across all samples. Otherwise, the scores will be calculated for each sample separately, and returns
a list with one <code>tibble</code> per sample.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p>Other network-methods:
<code><a href="get-network.html">GetSpatialNetwork</a>()</code></p>
<p>Other spatial-methods:
<code><a href="CutSpatialNetwork.html">CutSpatialNetwork</a>()</code>,
<code><a href="disconnect-regions.html">DisconnectRegions</a>()</code>,
<code><a href="get-network.html">GetSpatialNetwork</a>()</code>,
<code><a href="radial-distance.html">RadialDistance</a>()</code>,
<code><a href="region-neighbors.html">RegionNeighbors</a>()</code>,
<code><a href="label-assortativity.html">RunLabelAssortativityTest</a>()</code>,
<code><a href="local-G.html">RunLocalG</a>()</code>,
<code><a href="neighborhood-enrichment.html">RunNeighborhoodEnrichmentTest</a>()</code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Ludvig Larsson</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/mousebrain"</span>,</span></span>
<span class="r-in"><span>                                 <span class="st">"se_mbrain"</span>,</span></span>
<span class="r-in"><span>                                 package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">featureMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/FetchData.html" class="external-link">FetchData</a></span><span class="op">(</span><span class="va">se_mbrain</span>, vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/VariableFeatures.html" class="external-link">VariableFeatures</a></span><span class="op">(</span><span class="va">se_mbrain</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">coordfile</span> <span class="op">&lt;-</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/mousebrain/spatial"</span>,</span></span>
<span class="r-in"><span>              <span class="st">"tissue_positions_list.csv"</span>,</span></span>
<span class="r-in"><span>              package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Load coordinate data into a tibble</span></span></span>
<span class="r-in"><span><span class="va">xys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">coordfile</span>, header <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                nm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"barcode"</span>, <span class="st">"selection"</span>, <span class="st">"grid_y"</span>, <span class="st">"grid_x"</span>, <span class="st">"y"</span>, <span class="st">"x"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">xys</span><span class="op">$</span><span class="va">sampleID</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span></span>
<span class="r-in"><span><span class="va">xys</span> <span class="op">&lt;-</span> <span class="va">xys</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">selection</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">barcode</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">sampleID</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create spatial networks</span></span></span>
<span class="r-in"><span><span class="va">spatnet</span> <span class="op">&lt;-</span> <span class="fu"><a href="get-network.html">GetSpatialNetwork</a></span><span class="op">(</span><span class="va">xys</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">spatgenes</span> <span class="op">&lt;-</span> <span class="fu">CorSpatialFeatures</span><span class="op">(</span><span class="va">featureMat</span>, <span class="va">spatnet</span>, nCores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ── <span style="font-weight: bold;">Computing spatial autocorrelation</span> ──</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Sample 1:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Cleaned out spots with 0 adjacent neighbors</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature lag expression</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature spatial autocorrelation scores</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BB00;">✔</span>   Returning results</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check genes with highest spatial autocorrelation</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatgenes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 6 × 2</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   gene     cor</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span> Mbp    0.870</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span> Nrgn   0.857</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">3</span> Olfm1  0.798</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">4</span> Slc6a3 0.798</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">5</span> Trh    0.770</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">6</span> Th     0.757</span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/mousebrain"</span>,</span></span>
<span class="r-in"><span>                                 <span class="st">"se_mbrain"</span>,</span></span>
<span class="r-in"><span>                                 package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="va">se_mbrain</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Centering and scaling data matrix</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> PC_ 1 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Positive:  Nrgn, Olfm1, Cck, Nptxr, Rtn1, Snca, Nov, Tmsb4x, Lamp5, Egr1 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Crym, Cpne6, Coro1a, Arc, Hpca, Sst, Nr4a1, Npy, Chgb, Neurod6 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Snap25, Myh7, Uchl1, Eef1a2, Cort, Grp, Stmn2, Rprm, Spink8, Mfge8 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Negative:  Mbp, Plp1, Apod, Mobp, Ptgds, Mog, Mal, Mag, Cnp, Aldh1a1 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Opalin, Tcf7l2, Ddc, Lhx1os, Slc6a3, Ret, Th, Slc18a2, Sncg, Drd2 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Chrna6, Slc10a4, Spp1, En1, Dlk1, Calb2, Hbb-bs, Pvalb, Col1a2, Tnnt1 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> PC_ 2 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Positive:  Myoc, Gfap, Col1a2, Fmod, Slc13a4, Hba-a1, Hbb-bt, Slc6a20a, Hba-a2, Hbb-bs </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Acta2, Tagln, Mgp, Ogn, Vtn, H2-Aa, Lyz2, Cd74, Myl9, Dcn </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Myh11, Ptgds, Cytl1, H2-Eb1, Hmgcs2, Clu, Mfge8, Emp1, Npy, Cnn1 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Negative:  Th, Uchl1, Slc18a2, En1, Slc10a4, Slc6a3, Chrna6, Stmn2, Ret, Snap25 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Drd2, Dlk1, Ddc, Scg2, Sncg, Eef1a2, Rtn1, Chga, Pcp4, Calb2 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Mobp, Mbp, Chgb, Fabp5, Plp1, Pvalb, Mog, Mal, Mag, Snca </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> PC_ 3 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Positive:  Trbc2, Arc, Egr1, Myl4, Nr4a1, Mbp, Mobp, Pvalb, Plp1, Opalin </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Mog, Mal, Cnp, Mag, Snap25, Lamp5, Ighm, Tcf7l2, Cplx3, Tgm3 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Ighg2c, Pcp4, Hpca, Ly6d, Eef1a2, Tnnt1, Chga, Neurod6, Prph, Ctgf </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Negative:  Nnat, Slc18a2, Dlk1, Slc6a3, Slc10a4, En1, Th, Chrna6, Dcn, Sncg </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Cpne7, Drd2, Ddc, Ret, Hpcal1, Ecel1, Cpne6, Col1a2, Trh, Calb2 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Cd24a, Fmod, Mgp, Snca, Lypd1, Slc13a4, Fibcd1, Crym, Spink8, Slc6a20a </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> PC_ 4 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Positive:  Nr4a1, Arc, Lamp5, Egr1, Myl4, Trbc2, Chrna6, Tagln, En1, Snap25 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Th, Slc18a2, Acta2, Col1a2, Myh11, Fmod, Hba-a2, Slc10a4, Slc6a3, Slc13a4 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Ret, Tgm3, Hbb-bt, Slc6a20a, Ighm, Hbb-bs, Hba-a1, Vtn, Mgp, Drd2 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Negative:  Spink8, Fibcd1, Tmsb4x, Nnat, Lefty1, Crym, Cpne7, Nos1, Dcn, Cpne6 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Grp, Homer3, Htr3a, Tac1, Fabp5, C1ql2, Trh, Opalin, Mog, Plp1 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Mag, Calb2, Ecel1, Gfap, Cnp, Tcf7l2, Lypd1, Vgll3, Hpcal1, Mal </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> PC_ 5 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Positive:  Pcp4, Tcf7l2, Snap25, Uchl1, Eef1a2, Chga, Stmn2, Lhx1os, Calb2, Scg2 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Fabp5, Bok, Prkcd, Pvalb, Cartpt, Chgb, Tnnt1, Gpx3, Slc20a1, Rtn1 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   C1ql2, Spp1, Hpcal1, Ptgds, Pitx2, Lypd1, Aldh1a1, Ecel1, Vtn, Nme7 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Negative:  En1, Chrna6, Th, Slc18a2, Slc10a4, Ddc, Lefty1, Arc, Slc6a3, Neurod6 </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Grp, Nov, Lamp5, Fibcd1, Nr4a1, Drd2, Spink8, Vip, Myl4, Ret </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> 	   Egr1, Dlk1, Nrgn, Gfap, Trbc2, Tgm3, Myh7, Tac2, Sncg, Npy </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compute spatial autocorrelation for variable features</span></span></span>
<span class="r-in"><span><span class="va">spatgenes</span> <span class="op">&lt;-</span> <span class="fu">CorSpatialFeatures</span><span class="op">(</span><span class="va">se_mbrain</span>,</span></span>
<span class="r-in"><span>                                features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/VariableFeatures.html" class="external-link">VariableFeatures</a></span><span class="op">(</span><span class="va">se_mbrain</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                                nCores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ── <span style="font-weight: bold;">Computing spatial autocorrelation</span> ──</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Sample 1:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Cleaned out spots with 0 adjacent neighbors</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature lag expression</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature spatial autocorrelation scores</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BB00;">✔</span>   Returning results</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check genes with highest spatial autocorrelation</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatgenes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 6 × 2</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   gene     cor</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span> Mbp    0.870</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span> Nrgn   0.857</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">3</span> Cck    0.813</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">4</span> Olfm1  0.798</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">5</span> Slc6a3 0.798</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">6</span> Trh    0.770</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Note that the top variable genes are blood related (hemoglobin genes)</span></span></span>
<span class="r-in"><span><span class="co"># These genes have lower spatial autocorrelation since blood vessels</span></span></span>
<span class="r-in"><span><span class="co"># typically only cover a few spots and more randomly dispersed throughput the tissue</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/VariableFeatures.html" class="external-link">VariableFeatures</a></span><span class="op">(</span><span class="va">se_mbrain</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "Hbb-bs" "Hba-a1" "Hba-a2" "Hbb-bt" "Slc6a3" "Th"    </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># \donttest{</span></span></span>
<span class="r-in"><span><span class="co"># The same principle can be used to estimate spatial autocorrelation for other features,</span></span></span>
<span class="r-in"><span><span class="co"># for example dimensionality reduction vectors</span></span></span>
<span class="r-in"><span><span class="va">spatpcs</span> <span class="op">&lt;-</span> <span class="fu">CorSpatialFeatures</span><span class="op">(</span><span class="va">se_mbrain</span>,</span></span>
<span class="r-in"><span>                             features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"PC_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                             nCores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ── <span style="font-weight: bold;">Computing spatial autocorrelation</span> ──</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Sample 1:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Cleaned out spots with 0 adjacent neighbors</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature lag expression</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature spatial autocorrelation scores</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BB00;">✔</span>   Returning results</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Calculate spatial autocorrelation scores for principal components</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatpcs</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 6 × 2</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   gene    cor</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span> PC_1  0.934</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span> PC_3  0.890</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">3</span> PC_4  0.843</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">4</span> PC_2  0.822</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">5</span> PC_7  0.768</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">6</span> PC_5  0.739</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Compute spatial autocorrelation scores for multiple datasets</span></span></span>
<span class="r-in"><span><span class="va">se_mcolon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/mousecolon"</span>,</span></span>
<span class="r-in"><span>                                 <span class="st">"se_mcolon"</span>,</span></span>
<span class="r-in"><span>                                 package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="merge.html">MergeSTData</a></span><span class="op">(</span><span class="va">se_mbrain</span>, <span class="va">se_mcolon</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">spatgenes</span> <span class="op">&lt;-</span> <span class="fu">CorSpatialFeatures</span><span class="op">(</span><span class="va">se_merged</span>,</span></span>
<span class="r-in"><span>                                features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/VariableFeatures.html" class="external-link">VariableFeatures</a></span><span class="op">(</span><span class="va">se_merged</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                                nCores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ── <span style="font-weight: bold;">Computing spatial autocorrelation</span> ──</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Sample 1:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Cleaned out spots with 0 adjacent neighbors</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature lag expression</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature spatial autocorrelation scores</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BBBB;">ℹ</span> Sample 2:</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Cleaned out spots with 0 adjacent neighbors</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature lag expression</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> →   Computed feature spatial autocorrelation scores</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> <span style="color: #00BB00;">✔</span>   Returning results</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check spatial autocorrelation scores mouse brain data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatgenes</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 6 × 2</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   gene     cor</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span> Mbp    0.870</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span> Nrgn   0.857</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">3</span> Cck    0.813</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">4</span> Olfm1  0.798</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">5</span> Slc6a3 0.798</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">6</span> Trh    0.770</span>
<span class="r-in"><span><span class="co"># Check spatial autocorrelation scores mouse colon data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatgenes</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 6 × 2</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   gene    cor</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span> Prdx6 0.701</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span> Car1  0.616</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">3</span> Cnn1  0.562</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">4</span> Tgm3  0.556</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">5</span> Acta2 0.536</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">6</span> Tagln 0.530</span>
<span class="r-in"><span><span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/ludvigla" class="external-link">Ludvig Larsson</a>, <a href="https://github.com/lfranzen" class="external-link">Lovisa Franzen</a>, <a href="https://github.com/jemorlanes" class="external-link">Javier Escudero Morlanes</a>, <a href="https://www.spatialresearch.org/" class="external-link"><img src="reference/figures/sr-logo.png" height="36" alt="spatialresearch"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

