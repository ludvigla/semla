<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="semla">
<title>Image alignment • semla</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Image alignment">
<meta property="og:description" content="semla">
<meta property="og:image" content="https://ludvigla.github.io/semla/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">semla</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/semla.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tutorials">Tutorials</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tutorials">
    <h6 class="dropdown-header" data-toc-skip>Intro</h6>
    <a class="dropdown-item" href="../articles/getting_started.html">Get started</a>
    <a class="dropdown-item" href="../articles/subset_and_merge.html">Subset/merge</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Interactive</h6>
    <a class="dropdown-item" href="../articles/feature_viewer.html">Feature viewer</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial visualization</h6>
    <a class="dropdown-item" href="../articles/numeric_features.html">Map numeric features</a>
    <a class="dropdown-item" href="../articles/categorical_features.html">Map categorical features</a>
    <a class="dropdown-item" href="../articles/advanced_visualization.html">Advanced visualization</a>
    <a class="dropdown-item" href="../articles/scalebar.html">Scalebar</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial methods</h6>
    <a class="dropdown-item" href="../articles/radial_distances.html">Radial distances</a>
    <a class="dropdown-item" href="../articles/region_neighbors.html">Region neighbors</a>
    <a class="dropdown-item" href="../articles/spatial_statistics_for_labelled_spots.html">Statistics for labelled spots</a>
    <a class="dropdown-item" href="../articles/spatial_autocorrelation.html">Spatial autocorrelation</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Analysis</h6>
    <a class="dropdown-item" href="../articles/cell_type_mapping_with_NNLS.html">Cell type mapping</a>
    <a class="dropdown-item" href="../articles/digital_unrolling.html">Digital unrolling</a>
    <a class="dropdown-item" href="../articles/NNMF.html">Non-negative Matrix Factorization</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Image processing</h6>
    <a class="dropdown-item" href="../articles/images_and_coordinates.html">Images and spot coordinates</a>
    <a class="dropdown-item" href="../articles/mask_images.html">Image masking</a>
    <a class="dropdown-item" href="../articles/image_alignment.html">Image alignment</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ludvigla/semla" aria-label="GitHub">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Image alignment</h1>
                        <h4 data-toc-skip class="author">Ludvig
Larsson</h4>
            
            <h4 data-toc-skip class="date">Last compiled: 15 March
2023</h4>
      
      
      <div class="d-none name"><code>image_alignment.Rmd</code></div>
    </div>

    
    
<p>In this tutorial, we will look at two ways of transforming the
H&amp;E images in a 10x Visium dataset. The is typically useful if you
want to align similar tissue sections to make it easier to compare
results between them.</p>
<p>The alignment functions in <code>semla</code> only handles rigid
transformations, meaning that non-linear distortions are not possible to
mitigate. If rigid transformations are sufficient to generate a decent
alignment, one could for example use the aligned coordinates for 3D
visualization. However, we do not provide visualization functions for 3D
in <code>semla</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ludvigla.github.io/semla/">semla</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, </span>
<span>                                        <span class="st">"mousebrain/se_mbrain"</span>, </span>
<span>                                        package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="va">se_mbrain</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_mbrain</span><span class="op">)</span></span></code></pre></div>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p><code>semla</code> offers two ways of manipulating the orientation
and position of H&amp;E images using rigid transformations. Allowed
transformations are:</p>
<ul>
<li>
<strong>translation</strong> =&gt; move H&amp;E image along x-
and/or y-axis</li>
<li>
<strong>rotation</strong> =&gt; rotate image by a fixed degree</li>
<li>
<strong>mirror</strong> =&gt; mirror H&amp;E image along x- and/or
y-axis</li>
</ul>
<p>Transformations can be applied to the H&amp;E images programatically
or interactively:</p>
<ul>
<li>
<code>RigidTranformImages()</code>: if you know what transformations
to apply</li>
<li>
<code><a href="../reference/manual-transform-images.html">RunAlignment()</a></code>: opens an interactive viewer where you
can manipulate the H&amp;E images</li>
</ul>
<div class="section level2">
<h2 id="basic-image-transformation">Basic image transformation<a class="anchor" aria-label="anchor" href="#basic-image-transformation"></a>
</h2>
<p>The first step is to generate a tibble with the transformations that
you want to apply. <code><a href="../reference/generate_rigid_transform.html">generate_rigid_transform()</a></code> is a helper
function that makes this task a bit easier.</p>
<p>In the example below, we’ll mirror the H&amp;E image along the x
axis, rotate it by 30 degrees, move it 20% to the right and 20% up.
Translations (<code>tr_x</code> and <code>tr_y</code>) are provided as
proportions. For example, <code>tr_x = 0.1</code> means that you’ll move
the H&amp;E image 20% of the image width to the right.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transforms</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_rigid_transform.html">generate_rigid_transform</a></span><span class="op">(</span>mirror_x <span class="op">=</span> <span class="cn">TRUE</span>, angle <span class="op">=</span> <span class="fl">30</span>, tr_x <span class="op">=</span> <span class="fl">0.2</span>, tr_y <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">transforms</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">##   sampleID mirror_x mirror_y angle  tr_x  tr_y scalefactor</span></span>
<span><span class="co">##      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>        1 TRUE     FALSE       30   0.2  -<span style="color: #BB0000;">0.2</span>           1</span></span></code></pre>
<p>Now we are ready to apply the transformations:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transform-images.html">RigidTransformImages</a></span><span class="op">(</span><span class="va">se_mbrain</span>, transforms <span class="op">=</span> <span class="va">transforms</span><span class="op">)</span></span></code></pre></div>
<p>The original H&amp;E image is still stored in the <code>Seurat</code>
object, so when plotting we need to specify that we want to use the
transformed image:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_mbrain</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Original H&amp;E image"</span><span class="op">)</span></span></code></pre></div>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_mbrain</span>, image_use <span class="op">=</span> <span class="st">"transformed"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Transformed H&amp;E image"</span><span class="op">)</span></span></code></pre></div>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<p>The spot coordinates are transformed together with the H&amp;E image,
so if we use <code><a href="../reference/visualize-features.html">MapFeatures()</a></code> or <code><a href="../reference/visualize-labels.html">MapLabels()</a></code>, we
should see that the spots are still correctly positioned on the H&amp;E
image.</p>
<p>NB: Translations might result in moving parts of the H&amp;E image
outside of the predefined ‘canvas’. In our example below, this results
in some spots being located outside of the view and these will therefore
be dropped. The original image dimensions are always retained.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_mbrain</span>, features <span class="op">=</span> <span class="st">"nFeature_Spatial"</span>, image_use <span class="op">=</span> <span class="st">"transformed"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Returning more (or less) than 1 row per `summarise()` group was deprecated in</span></span>
<span><span class="co">## dplyr 1.1.0.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Please use `reframe()` instead.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> When switching from `summarise()` to `reframe()`, remember that `reframe()`</span></span>
<span><span class="co">##   always returns an ungrouped data frame and adjust accordingly.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> The deprecated feature was likely used in the <span style="color: #0000BB;">semla</span> package.</span></span>
<span><span class="co">##   Please report the issue to the authors.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Removed 27 rows containing missing values (`geom_point()`).</span></span></code></pre>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="interactive-alignment">Interactive alignment<a class="anchor" aria-label="anchor" href="#interactive-alignment"></a>
</h2>
<p>Here we will take a look at three H&amp;E images with different
orientations, and the goal is to align them to a common coordinate
system.</p>
<p>You can click on ‘show’ to see the code used to generate this dummy
data using <code>RigidTransformImages</code>.</p>
<details><summary>
show
</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">MergeSTData</a></span><span class="op">(</span><span class="va">se_mbrain</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">se_mbrain</span>, <span class="va">se_mbrain</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">transforms1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_rigid_transform.html">generate_rigid_transform</a></span><span class="op">(</span>mirror_x <span class="op">=</span> <span class="cn">TRUE</span>, angle <span class="op">=</span> <span class="fl">45</span>, sampleID <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">transforms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_rigid_transform.html">generate_rigid_transform</a></span><span class="op">(</span>mirror_x <span class="op">=</span> <span class="cn">TRUE</span>, scalefactor <span class="op">=</span> <span class="fl">0.8</span>, sampleID <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">transforms3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_rigid_transform.html">generate_rigid_transform</a></span><span class="op">(</span>mirror_y <span class="op">=</span> <span class="cn">TRUE</span>, scalefactor <span class="op">=</span> <span class="fl">0.6</span>, sampleID <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">transforms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">transforms1</span>, <span class="va">transforms2</span>, <span class="va">transforms3</span><span class="op">)</span></span>
<span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transform-images.html">RigidTransformImages</a></span><span class="op">(</span><span class="va">se_merged</span>, transforms <span class="op">=</span> <span class="va">transforms</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">rasterlists</span><span class="op">$</span><span class="va">raw</span> <span class="op">&lt;-</span> <span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">rasterlists</span><span class="op">$</span><span class="va">transformed</span></span>
<span><span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">rasterlists</span><span class="op">$</span><span class="va">transformed</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">meta_data</span> <span class="op">&lt;-</span> <span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">meta_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">pxl_col_in_fullres</span>, <span class="op">-</span><span class="va">pxl_row_in_fullres</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>pxl_col_in_fullres <span class="op">=</span> <span class="va">pxl_col_in_fullres_transformed</span>, pxl_row_in_fullres <span class="op">=</span> <span class="va">pxl_row_in_fullres_transformed</span><span class="op">)</span></span></code></pre></div>
</details><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_merged</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/manual-transform-images.html">RunAlignment</a></span><span class="op">(</span><span class="va">se_merged</span><span class="op">)</span></span></code></pre></div>
<p>When we call <code>RunAlignment</code>, an interactive application
will open up in a separate window.</p>
<p><img src="images/alignment/alignment_start.png"></p>
<p>If you click on <code>Help</code>, you will see instructions on how
to use the app:</p>
<p><img src="images/alignment/help_menu.png"></p>
<p>We can select what H&amp;E images should be put into view by clicking
on the button above the alignment panel:</p>
<p><img src="images/alignment/selected_image.png"></p>
<p>H&amp;E images can be moved around by dragging the image with the
cursor. The dotted borders around the H&amp;E images highlights the
dimensions of the ‘canvas’. Anything outside of these borders will be
removed.</p>
<p>Some of the interaction is handled by pressing a key and clicking on
an H&amp;E image. For example, you can change the transparency by
holding <code>q</code> or <code>w</code> and clicking on an H&amp;E
image.</p>
<p>We can rotate an H&amp;E image by holding <code>SHIFT</code> and
dragging the blue dot in the corner of the image. Similarly, scaling can
be done by holding and dragging the blue dot.</p>
<p>In the example below, we can see that ‘image2’ has been scaled and
rotated to align with ‘image1’. All that is left is align ‘image2’ with
‘image1’:</p>
<p><img src="images/alignment/rotated_and_scaled.png"></p>
<p>In the end, we should be able to get a decent alignment of the three
H&amp;E images. The table on top of the alignment panel shows the
transformations that have been applied:</p>
<p><img src="images/alignment/aligned_images.png"></p>
<p>Once we are satisfied with the alignment, we can press the
<code>Quit &amp; Save</code> button which will trigger the alignment of
our H&amp;E images (in R) and the results will be saved to our
<code>Seurat</code> object.</p>
<p>If we set <code>image_use='transformed'</code> in
<code>MapFeatures</code>, we will see that the the H&amp;E images are
now aligned.</p>
<p>NB: Manipulating the images will often lead to some cropping. In the
first image below, we can see that the corners are cropped and filled
with empty white space.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_merged</span>, features <span class="op">=</span> <span class="st">"nFeature_Spatial"</span>, image_use <span class="op">=</span> <span class="st">"transformed"</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/alignment/unique_genes_aligned.jpeg"></p>
<p>Now that the data is aligned, it will be easier to look at specific
areas of the tissue sections with the <code>crop_area</code> option</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="va">se_merged</span>, image_height <span class="op">=</span> <span class="fl">1.5e3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_merged</span>, features <span class="op">=</span> <span class="st">"nFeature_Spatial"</span>, image_use <span class="op">=</span> <span class="st">"transformed"</span>, </span>
<span>            ncol <span class="op">=</span> <span class="fl">3</span>, crop_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.43</span>, <span class="fl">0.6</span>, <span class="fl">0.67</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/alignment/aligned_cropped.jpg"></p>
</div>
<div class="section level2">
<h2 id="images-with-different-dimensions">Images with different dimensions<a class="anchor" aria-label="anchor" href="#images-with-different-dimensions"></a>
</h2>
<p><code>RunAlignment</code> applies the transformations to each image
independently and makes sure that the original dimensions of the images
are kept. This behavior might seem confusing at first. Let’s say that
you want to force all images to align with the first H&amp;E image so
that you can use the transformed coordinates for 3D visualization, this
will not work without some additional processing.</p>
<p>In the example below, we can see two H&amp;E images with slightly
different dimensions. The second image (mouse colon tissue) has an
aspect ration lower than 1 whereas the first image (mouse brain tissue)
has an aspect ratio higher than 1 but both images are loaded with the
same height. When applying transformations to the second image, the
dashed box will only define where the image will be placed relative to
the first image, but the image will keep its aspect ratio.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, </span>
<span>                                        <span class="st">"mousebrain/se_mbrain"</span>, </span>
<span>                                        package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">se_mcolon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, </span>
<span>                                        <span class="st">"mousecolon/se_mcolon"</span>, </span>
<span>                                        package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">MergeSTData</a></span><span class="op">(</span><span class="va">se_mbrain</span>, <span class="va">se_mcolon</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/manual-transform-images.html">RunAlignment</a></span><span class="op">(</span><span class="va">se_merged</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/alignment/alignment_brain_colon.png"> If we apply
rigid transformations according to the image above, the result will be
this:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_merged</span>, image_use <span class="op">=</span> <span class="st">"transformed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/alignment/transformed_images_brain_colon.jpg"></p>
<p>Here you can see that the second image fits the top and bottom of the
dashed box, but the sides are wider than the box.</p>
</div>
<div class="section level2">
<h2 id="d-visualization">3D visualization<a class="anchor" aria-label="anchor" href="#d-visualization"></a>
</h2>
<p>3D visualization requires some additional processing. For each tissue
section, the spot coordinates can be defined on completely different
scales. In order to place the coordinates on the same scale, we can
adjust the coordinates by dividing them with the width/height of the
H&amp;E images.</p>
<p>The code below can be used to scale the transformed coordinates to a
common coordinate system, in this case they will range from 0 to 1. We
can use the <code>sampleID</code> as a z-coordinate to create a
“z-stack” that can be visualized in 3D. We’ll leave the actual 3D
visualization as an exercise, but to achieve this you can for example
use the R package <a href="https://plotly.com/r/" class="external-link">plotly</a>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xy_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetStaffli.html">GetStaffli</a></span><span class="op">(</span><span class="va">se_merged</span><span class="op">)</span><span class="op">@</span><span class="va">meta_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pxl_col_in_fullres_transformed</span>, <span class="va">pxl_row_in_fullres_transformed</span>, <span class="va">sampleID</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">sampleID</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html" class="external-link">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">image_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetStaffli.html">GetStaffli</a></span><span class="op">(</span><span class="va">se_merged</span><span class="op">)</span><span class="op">@</span><span class="va">image_info</span></span>
<span></span>
<span><span class="co"># Adjust coordinates</span></span>
<span><span class="va">adjusted_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">bind_rows</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">xy_coords</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">xy</span> <span class="op">&lt;-</span> <span class="va">xy_coords</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">full_width</span> <span class="op">&lt;-</span> <span class="va">image_info</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">$</span><span class="va">full_width</span></span>
<span>  <span class="va">full_height</span> <span class="op">&lt;-</span> <span class="va">image_info</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span><span class="op">$</span><span class="va">full_height</span></span>
<span>  <span class="va">xy</span> <span class="op">&lt;-</span> <span class="va">xy</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">pxl_col_in_fullres_transformed</span><span class="op">/</span><span class="va">full_width</span>,</span>
<span>           y <span class="op">=</span> <span class="va">pxl_row_in_fullres_transformed</span><span class="op">/</span><span class="va">full_height</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">sampleID</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<hr>
<details open><summary><strong>Package version</strong>
</summary><ul>
<li>
<code>semla</code>: 0.1.0</li>
</ul></details><details><summary><strong>Session info</strong>
</summary><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.2.1 (2022-06-23)</span></span>
<span><span class="co">## Platform: x86_64-apple-darwin13.4.0 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Big Sur ... 10.16</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS/LAPACK: /Users/ludviglarsson/miniconda3/envs/R4.2/lib/libopenblasp-r0.3.21.dylib</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] semla_0.1.0        ggplot2_3.4.1      dplyr_1.1.0        SeuratObject_4.1.3</span></span>
<span><span class="co">## [5] Seurat_4.3.0      </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] Rtsne_0.16             colorspace_2.0-3       deldir_1.0-6          </span></span>
<span><span class="co">##   [4] ellipsis_0.3.2         ggridges_0.5.3         rprojroot_2.0.3       </span></span>
<span><span class="co">##   [7] fs_1.5.2               spatstat.data_3.0-0    rstudioapi_0.14       </span></span>
<span><span class="co">##  [10] farver_2.1.1           leiden_0.4.2           listenv_0.8.0         </span></span>
<span><span class="co">##  [13] ggrepel_0.9.3          fansi_1.0.3            codetools_0.2-18      </span></span>
<span><span class="co">##  [16] splines_4.2.1          cachem_1.0.6           knitr_1.39            </span></span>
<span><span class="co">##  [19] zeallot_0.1.0          polyclip_1.10-0        jsonlite_1.8.3        </span></span>
<span><span class="co">##  [22] ica_1.0-3              cluster_2.1.4          png_0.1-7             </span></span>
<span><span class="co">##  [25] uwot_0.1.14            spatstat.sparse_3.0-0  shiny_1.7.4           </span></span>
<span><span class="co">##  [28] sctransform_0.3.5      compiler_4.2.1         httr_1.4.4            </span></span>
<span><span class="co">##  [31] Matrix_1.5-3           fastmap_1.1.0          lazyeval_0.2.2        </span></span>
<span><span class="co">##  [34] cli_3.4.1              later_1.3.0            htmltools_0.5.4       </span></span>
<span><span class="co">##  [37] tools_4.2.1            igraph_1.3.4           gtable_0.3.0          </span></span>
<span><span class="co">##  [40] glue_1.6.2             RANN_2.6.1             reshape2_1.4.4        </span></span>
<span><span class="co">##  [43] Rcpp_1.0.9             scattermore_0.8        jquerylib_0.1.4       </span></span>
<span><span class="co">##  [46] pkgdown_2.0.6          vctrs_0.5.2            nlme_3.1-159          </span></span>
<span><span class="co">##  [49] spatstat.explore_3.0-5 progressr_0.10.1       lmtest_0.9-40         </span></span>
<span><span class="co">##  [52] spatstat.random_3.0-1  xfun_0.32              stringr_1.5.0         </span></span>
<span><span class="co">##  [55] globals_0.16.0         mime_0.12              miniUI_0.1.1.1        </span></span>
<span><span class="co">##  [58] lifecycle_1.0.3        irlba_2.3.5            goftest_1.2-3         </span></span>
<span><span class="co">##  [61] future_1.27.0          MASS_7.3-58.1          zoo_1.8-10            </span></span>
<span><span class="co">##  [64] scales_1.2.1           ragg_1.2.2             promises_1.2.0.1      </span></span>
<span><span class="co">##  [67] spatstat.utils_3.0-1   parallel_4.2.1         RColorBrewer_1.1-3    </span></span>
<span><span class="co">##  [70] yaml_2.3.5             memoise_2.0.1          reticulate_1.26       </span></span>
<span><span class="co">##  [73] pbapply_1.5-0          gridExtra_2.3          sass_0.4.2            </span></span>
<span><span class="co">##  [76] stringi_1.7.8          highr_0.9              desc_1.4.1            </span></span>
<span><span class="co">##  [79] rlang_1.0.6            pkgconfig_2.0.3        systemfonts_1.0.4     </span></span>
<span><span class="co">##  [82] matrixStats_0.62.0     evaluate_0.16          lattice_0.20-45       </span></span>
<span><span class="co">##  [85] tensor_1.5             ROCR_1.0-11            purrr_1.0.1           </span></span>
<span><span class="co">##  [88] labeling_0.4.2         patchwork_1.1.2        htmlwidgets_1.5.4     </span></span>
<span><span class="co">##  [91] cowplot_1.1.1          tidyselect_1.2.0       parallelly_1.32.1     </span></span>
<span><span class="co">##  [94] RcppAnnoy_0.0.19       plyr_1.8.7             magrittr_2.0.3        </span></span>
<span><span class="co">##  [97] R6_2.5.1               magick_2.7.3           generics_0.1.3        </span></span>
<span><span class="co">## [100] DBI_1.1.3              withr_2.5.0            pillar_1.8.1          </span></span>
<span><span class="co">## [103] fitdistrplus_1.1-8     abind_1.4-5            survival_3.4-0        </span></span>
<span><span class="co">## [106] sp_1.5-1               tibble_3.1.8           future.apply_1.9.0    </span></span>
<span><span class="co">## [109] KernSmooth_2.23-20     utf8_1.2.2             spatstat.geom_3.0-3   </span></span>
<span><span class="co">## [112] plotly_4.10.0          rmarkdown_2.15         grid_4.2.1            </span></span>
<span><span class="co">## [115] data.table_1.14.2      forcats_0.5.2          digest_0.6.29         </span></span>
<span><span class="co">## [118] xtable_1.8-4           dbscan_1.1-10          tidyr_1.3.0           </span></span>
<span><span class="co">## [121] httpuv_1.6.5           textshaping_0.3.6      munsell_0.5.0         </span></span>
<span><span class="co">## [124] viridisLite_0.4.1      bslib_0.4.0            shinyjs_2.1.0</span></span></code></pre>
</details><p><br></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/ludvigla" class="external-link">Ludvig Larsson</a>, <a href="https://github.com/lfranzen" class="external-link">Lovisa Franzen</a>, <a href="https://www.spatialresearch.org/" class="external-link"><img src="reference/figures/sr-logo.png" height="36" alt="spatialresearch"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
