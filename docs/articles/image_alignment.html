<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="STUtility2">
<title>Image alignment • STUtility2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Image alignment">
<meta property="og:description" content="STUtility2">
<meta property="og:image" content="https://ludvigla.github.io/STUtility2/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">STUtility2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/STUtility2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tutorials">Tutorials</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tutorials">
    <h6 class="dropdown-header" data-toc-skip>Intro</h6>
    <a class="dropdown-item" href="../articles/getting_started.html">Get started</a>
    <a class="dropdown-item" href="../articles/subset_and_merge.html">Subset/merge</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Interactive</h6>
    <a class="dropdown-item" href="../articles/feature_viewer.html">Feature viewer</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial visualization</h6>
    <a class="dropdown-item" href="../articles/numeric_features.html">Map numeric features</a>
    <a class="dropdown-item" href="../articles/categorical_features.html">Map categorical features</a>
    <a class="dropdown-item" href="../articles/advanced_visualization.html">Advanced visualization</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial methods</h6>
    <a class="dropdown-item" href="../articles/radial_distances.html">Radial distances</a>
    <a class="dropdown-item" href="../articles/region_neighbors.html">Region neighbors</a>
    <a class="dropdown-item" href="../articles/spatial_statistics_for_labelled_spots.html">Statistics for labelled spots</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Analysis</h6>
    <a class="dropdown-item" href="../articles/cell_type_mapping_with_NNLS.html">Cell type mapping</a>
    <a class="dropdown-item" href="../articles/digital_unrolling.html">Digital unrolling</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Image processing</h6>
    <a class="dropdown-item" href="../articles/images_and_coordinates.html">Images and spot coordinates</a>
    <a class="dropdown-item" href="../articles/image_alignment.html">Image alignment</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Image alignment</h1>
                        <h4 data-toc-skip class="author">Ludvig
Larsson</h4>
            
            <h4 data-toc-skip class="date">2023-01-12</h4>
      
      
      <div class="d-none name"><code>image_alignment.Rmd</code></div>
    </div>

    
    
<p>In this tutorial, we will look at two ways of transforming the
H&amp;E images in a 10x Visium dataset. The is typically useful if you
want to align similar tissue sections to make it easier to compare
results between them.</p>
<p>The alignment functions in <code>STUtility2</code> only handles rigid
transformations, meaning that non-linear distortions are not possible to
mitigate. If rigid transformations are sufficient to generate a decent
alignment, one could for example use the aligned coordinates for 3D
visualization. However, we do not provide visualization functions for 3D
in <code>STUtility2</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ludvigla.github.io/STUtility2/">STUtility2</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, </span>
<span>                                        <span class="st">"mousebrain/se_mbrain"</span>, </span>
<span>                                        package <span class="op">=</span> <span class="st">"STUtility2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="va">se_mbrain</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_mbrain</span><span class="op">)</span></span></code></pre></div>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p><code>STUtility2</code> offers two ways of manipulating the
orientation and position of H&amp;E images using rigid transformations.
Allowed transformations are:</p>
<ul>
<li>translation =&gt; move H&amp;E image along x- and/or y-axis</li>
<li>rotation =&gt; rotate image by a fixed degree</li>
<li>mirror =&gt; mirror H&amp;E image along x- and/or y-axis</li>
</ul>
<p>Transformations can be applied to the H&amp;E images programatically
or interactively:</p>
<ul>
<li>
<code>RigidTranformImages</code>: if you know what transformations
to apply</li>
<li>
<code>RunAlignment</code>: opens an interactive viewer where you can
manipulate the H&amp;E images</li>
</ul>
<div class="section level2">
<h2 id="basic-image-transformation">Basic image transformation<a class="anchor" aria-label="anchor" href="#basic-image-transformation"></a>
</h2>
<p>The first step is to generate a tibble with the transformations that
you want to apply. <code>generate_rigid_transform</code> is a helper
function that makes this task a bit easier.</p>
<p>In the example below, we’ll mirror the H&amp;E image along the x
axis, rotate it by 30 degrees, move it 20% to the right and 20% up.
Translations (<code>tr_x</code> and <code>tr_y</code>) are provided as
proportions. For example, <code>tr_x = 0.1</code> means that you’ll move
the H&amp;E image 20% of the image width to the right.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transforms</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_rigid_transform.html">generate_rigid_transform</a></span><span class="op">(</span>mirror_x <span class="op">=</span> <span class="cn">TRUE</span>, angle <span class="op">=</span> <span class="fl">30</span>, tr_x <span class="op">=</span> <span class="fl">0.2</span>, tr_y <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="va">transforms</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">##   sampleID mirror_x mirror_y angle  tr_x  tr_y scalefactor</span></span>
<span><span class="co">##      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>        1 TRUE     FALSE       30   0.2  -<span style="color: #BB0000;">0.2</span>           1</span></span></code></pre>
<p>Now we are ready to apply the transformations:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transform-images.html">RigidTransformImages</a></span><span class="op">(</span><span class="va">se_mbrain</span>, transforms <span class="op">=</span> <span class="va">transforms</span><span class="op">)</span></span></code></pre></div>
<p>The original H&amp;E image is still stored in the <code>Seurat</code>
object, so when plotting we need to specify that we want to use the
transformed image:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_mbrain</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Original H&amp;E image"</span><span class="op">)</span></span></code></pre></div>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_mbrain</span>, image_use <span class="op">=</span> <span class="st">"transformed"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Transformed H&amp;E image"</span><span class="op">)</span></span></code></pre></div>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<p>The spot coordinates are transformed together with the H&amp;E image,
so if we use <code>MapFeatures</code> or <code>MapLabels</code>, we
should see that the spots are still correctly positioned on the H&amp;E
image.</p>
<p>NB: Translations might result in moving parts of the H&amp;E image
outside of the predefined ‘canvas’. In our example below, this results
in some spots being located outside of the view and these will therefore
be dropped. The original image dimensions are always retained.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_mbrain</span>, features <span class="op">=</span> <span class="st">"nFeature_Spatial"</span>, image_use <span class="op">=</span> <span class="st">"transformed"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 27 rows containing missing values (`geom_point()`).</span></span></code></pre>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="interactive-alignment">Interactive alignment<a class="anchor" aria-label="anchor" href="#interactive-alignment"></a>
</h2>
<p>Here we will take a look at three H&amp;E images with different
orientations, and the goal is to align them to a common coordinate
system.</p>
<p>You can click on ‘show’ to see the code I have used to generate this
dummy data using <code>RigidTransformImages</code>.</p>
<details><summary>
show
</summary><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">MergeSTData</a></span><span class="op">(</span><span class="va">se_mbrain</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">se_mbrain</span>, <span class="va">se_mbrain</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">transforms1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_rigid_transform.html">generate_rigid_transform</a></span><span class="op">(</span>mirror_x <span class="op">=</span> <span class="cn">TRUE</span>, angle <span class="op">=</span> <span class="fl">45</span>, sampleID <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">transforms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_rigid_transform.html">generate_rigid_transform</a></span><span class="op">(</span>mirror_x <span class="op">=</span> <span class="cn">TRUE</span>, scalefactor <span class="op">=</span> <span class="fl">0.8</span>, sampleID <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">transforms3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_rigid_transform.html">generate_rigid_transform</a></span><span class="op">(</span>mirror_y <span class="op">=</span> <span class="cn">TRUE</span>, scalefactor <span class="op">=</span> <span class="fl">0.6</span>, sampleID <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">transforms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">transforms1</span>, <span class="va">transforms2</span>, <span class="va">transforms3</span><span class="op">)</span></span>
<span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/transform-images.html">RigidTransformImages</a></span><span class="op">(</span><span class="va">se_merged</span>, transforms <span class="op">=</span> <span class="va">transforms</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">rasterlists</span><span class="op">$</span><span class="va">raw</span> <span class="op">&lt;-</span> <span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">rasterlists</span><span class="op">$</span><span class="va">transformed</span></span>
<span><span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">rasterlists</span><span class="op">$</span><span class="va">transformed</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">meta_data</span> <span class="op">&lt;-</span> <span class="va">se_merged</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">meta_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">pxl_col_in_fullres</span>, <span class="op">-</span><span class="va">pxl_row_in_fullres</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>pxl_col_in_fullres <span class="op">=</span> <span class="va">pxl_col_in_fullres_transformed</span>, pxl_row_in_fullres <span class="op">=</span> <span class="va">pxl_row_in_fullres_transformed</span><span class="op">)</span></span></code></pre></div>
</details><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_merged</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="image_alignment_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/manual-transform-images.html">RunAlignment</a></span><span class="op">(</span><span class="va">se_merged</span><span class="op">)</span></span></code></pre></div>
<p>When we call <code>RunAlignment</code>, an interactive application
will open up in a separate window.</p>
<p><img src="images/alignment/alignment_start.png"></p>
<p>If you click on help, you will see instructions on how to use the
app:</p>
<p><img src="images/alignment/help_menu.png"></p>
<p>We can select what H&amp;E images should be put into view by clicking
on the button above the alignment panel:</p>
<p><img src="images/alignment/selected_image.png"></p>
<p>H&amp;E images can be moved around by dragging the image with the
cursor. The dotted borders around the H&amp;E images highlights the
dimensions of the ‘canvas’. Anything outside of these borders will be
removed.</p>
<p>Some of the interaction is handled by pressing a key and clicking on
an H&amp;E image. For example, you can change the transparency by
holding <code>q</code> or <code>w</code> and clicking on an H&amp;E
image.</p>
<p>We can rotate an H&amp;E image by holding <code>SHIFT</code> and
dragging the blue dot in the corner of the image. Similarly, scaling can
be done by holding and dragging the blue dot.</p>
<p>In the example below, we can see that ‘image2’ has been scaled and
rotated to align with ‘image1’. All that is left is align ‘image2’ with
‘image1’:</p>
<p><img src="images/alignment/rotated_and_scaled.png"> In the end, we
should be able to get a decent alignment of the three H&amp;E images.
The table on top of the alignment panel shows the transformations that
have been applied:</p>
<p><img src="images/alignment/aligned_images.png"></p>
<p>Once we are satisfied with the alignment, we can press the
<code>Quit &amp; save</code> button which will trigger the alignment of
our H&amp;E images (in R) and the results will be saved to our
<code>Seurat</code> object.</p>
<p>If we set <code>image_use='transformed'</code> in
<code>MapFeatures</code>, we will see that the the H&amp;E images are
now aligned.</p>
<p>NB: Manipulating the images will often lead to some cropping. In the
first image below, we can see that the corners are cropped and filled
with empty white space.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_merged</span>, features <span class="op">=</span> <span class="st">"nFeature_Spatial"</span>, image_use <span class="op">=</span> <span class="st">"transformed"</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/alignment/unique_genes_aligned.jpeg"></p>
<p>Now that the data is aligned, it will be easier to look at specific
areas of the tissue sections with the <code>crop_area</code> option</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="va">se_merged</span>, image_height <span class="op">=</span> <span class="fl">1.5e3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_merged</span>, features <span class="op">=</span> <span class="st">"nFeature_Spatial"</span>, image_use <span class="op">=</span> <span class="st">"transformed"</span>, </span>
<span>            ncol <span class="op">=</span> <span class="fl">3</span>, crop_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.43</span>, <span class="fl">0.6</span>, <span class="fl">0.67</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images/alignment/aligned_cropped.jpg"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/ludvigla" class="external-link">Ludvig Larsson</a>, <a href="https://github.com/lfranzen" class="external-link">Lovisa Franzen</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
