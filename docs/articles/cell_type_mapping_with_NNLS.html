<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="STUtility2">
<title>Cell type mapping with NNLS • STUtility2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Cell type mapping with NNLS">
<meta property="og:description" content="STUtility2">
<meta property="og:image" content="https://ludvigla.github.io/STUtility2/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-inverse navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">STUtility2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/STUtility2.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tutorials">Tutorials</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tutorials">
    <h6 class="dropdown-header" data-toc-skip>Intro</h6>
    <a class="dropdown-item" href="../articles/getting_started.html">Get started</a>
    <a class="dropdown-item" href="../articles/subset_and_merge.html">Subset/merge</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Interactive</h6>
    <a class="dropdown-item" href="../articles/feature_viewer.html">Feature viewer</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial visualization</h6>
    <a class="dropdown-item" href="../articles/numeric_features.html">Map numeric features</a>
    <a class="dropdown-item" href="../articles/categorical_features.html">Map categorical features</a>
    <a class="dropdown-item" href="../articles/advanced_visualization.html">Advanced visualization</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial methods</h6>
    <a class="dropdown-item" href="../articles/radial_distances.html">Radial distances</a>
    <a class="dropdown-item" href="../articles/region_neighbors.html">Region neighbors</a>
    <a class="dropdown-item" href="../articles/spatial_statistics_for_labelled_spots.html">Statistics for labelled spots</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Analysis</h6>
    <a class="dropdown-item" href="../articles/cell_type_mapping_with_NNLS.html">Cell type mapping</a>
    <a class="dropdown-item" href="../articles/digital_unrolling.html">Digital unrolling</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Image processing</h6>
    <a class="dropdown-item" href="../articles/images_and_coordinates.html">Images and spot coordinates</a>
    <a class="dropdown-item" href="../articles/image_alignment.html">Image alignment</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Cell type mapping with NNLS</h1>
            
      
      
      <div class="d-none name"><code>cell_type_mapping_with_NNLS.rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ludvigla.github.io/STUtility2/">STUtility2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">'TabulaMurisSenisData'</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"TabulaMurisSenisData"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/fmicompbio/TabulaMurisSenisData" class="external-link">TabulaMurisSenisData</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>Cell type mapping with SRT data refers to a set of methods which
allows you to infer the quantity of cells from SRT expression profiles.
<code>STUtility2</code> offers a quick method based on Non-Negative
Least Squares to infer cell type proportions directly from Visium spot
expression profiles.</p>
<p>In this tutorial, we’ll take a look at two examples. First, we have
two tissue sections of a mouse brain and a single cell RNA-seq dataset
from the Allen Brain Atlas. In the second example, we have a mouse
kidney section and single cell RNA-seq data from the Tabula Muris
Senis.</p>
<div class="section level2">
<h2 id="mouse-brain">Mouse brain<a class="anchor" aria-label="anchor" href="#mouse-brain"></a>
</h2>
<p>For this tutorial, we will use a single-cell dataset from the Allen
Brain Atlas. You can check the code chunk below or follow <a href="https://www.dropbox.com/s/cuowvm4vrf65pvq/allen_cortex.rds?dl=1" class="external-link">this</a>
link to download it manually.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>timeout<span class="op">=</span><span class="fl">200</span><span class="op">)</span></span>
<span><span class="va">tmpdir</span> <span class="op">&lt;-</span> <span class="st">"."</span> <span class="co"># Set current wd or change to tmpdir()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"/mousebrain"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">targetdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"/mousebrain"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/single-cell"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">destfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/single-cell/allen_brain.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="st">"https://www.dropbox.com/s/cuowvm4vrf65pvq/allen_cortex.rds?dl=1"</span>, destfile <span class="op">=</span> <span class="va">destfile</span><span class="op">)</span></span></code></pre></div>
<p>We will also need to download the 10x Visium data from 10x Genomics
website. You can download the files directly with R by following the
code chunk below or download the data directly from <a href="https://www.10xgenomics.com/resources/datasets" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download section 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S1"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://cf.10xgenomics.com/samples/spatial-exp/1.0.0/V1_Mouse_Brain_Sagittal_Anterior/V1_Mouse_Brain_Sagittal_Anterior_filtered_feature_bc_matrix.h5"</span>, destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S1/filtered_feature_bc_matrix.h5"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://cf.10xgenomics.com/samples/spatial-exp/1.0.0/V1_Mouse_Brain_Sagittal_Anterior/V1_Mouse_Brain_Sagittal_Anterior_spatial.tar.gz"</span>,</span>
<span>              destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S1/spatial.tar.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/untar.html" class="external-link">untar</a></span><span class="op">(</span>tarfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S1/spatial.tar.gz"</span><span class="op">)</span>, </span>
<span>      exdir <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S1/"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S1/spatial.tar.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download section 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://cf.10xgenomics.com/samples/spatial-exp/1.0.0/V1_Mouse_Brain_Sagittal_Posterior/V1_Mouse_Brain_Sagittal_Posterior_filtered_feature_bc_matrix.h5"</span>, destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S2/filtered_feature_bc_matrix.h5"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://cf.10xgenomics.com/samples/spatial-exp/1.0.0/V1_Mouse_Brain_Sagittal_Posterior/V1_Mouse_Brain_Sagittal_Posterior_spatial.tar.gz"</span>,</span>
<span>              destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S2/spatial.tar.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/untar.html" class="external-link">untar</a></span><span class="op">(</span>tarfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S2/spatial.tar.gz"</span><span class="op">)</span>, </span>
<span>      exdir <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S2/"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/S2/spatial.tar.gz"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Load Visium data with STUtility2 into a Seurat object. The following
steps assumes that the mouse brain 10x Visium data is located in
<code>./mousebrain/visium/</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Assemble spaceranger output files</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html" class="external-link">Sys.glob</a></span><span class="op">(</span><span class="st">"./mousebrain/visium/*/filtered_feature_bc_matrix.h5"</span><span class="op">)</span></span>
<span><span class="va">imgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html" class="external-link">Sys.glob</a></span><span class="op">(</span><span class="st">"./mousebrain/visium/*/spatial/tissue_hires_image.png"</span><span class="op">)</span></span>
<span><span class="va">spotfiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html" class="external-link">Sys.glob</a></span><span class="op">(</span><span class="st">"./mousebrain/visium/*/spatial/tissue_positions_list.csv"</span><span class="op">)</span></span>
<span><span class="va">json</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html" class="external-link">Sys.glob</a></span><span class="op">(</span><span class="st">"./mousebrain/visium/*/spatial/scalefactors_json.json"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">infoTable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">imgs</span>, <span class="va">spotfiles</span>, <span class="va">json</span>, section_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"section_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create Seurat object with 1 Sagittal Anterior section and 1 Sagittal Posterior section</span></span>
<span><span class="va">se_brain_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ReadVisiumData.html">ReadVisiumData</a></span><span class="op">(</span><span class="va">infoTable</span><span class="op">)</span></span></code></pre></div>
<p>Load single-cell data</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_allen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"./mousebrain/single-cell/allen_brain.rds"</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="normalize-data">Normalize data<a class="anchor" aria-label="anchor" href="#normalize-data"></a>
</h3>
<p>Here we will apply the same log-normalization procedure to both the
10x Visium data (<code>se_brain_spatial</code>) and to the single-cell
data (<code>se_brain_singlecell</code>). We set the number of variable
features quite high because later on we will use the intersect between
the variable features in the single-cell data and the variable features
in the 10x Visium data for NNLS. The NNLS method is quite fast so there
is actually no need to select only a subset of features. Instead, we can
just use all genes that are shared across the single-cell and 10x Visium
data.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Normalize data and find variable features for Visium data</span></span>
<span><span class="va">se_brain_spatial</span> <span class="op">&lt;-</span> <span class="va">se_brain_spatial</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>nfeatures <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Normalize data and run vanilla analysis to create UMAP embedding</span></span>
<span><span class="va">se_allen</span> <span class="op">&lt;-</span> <span class="va">se_allen</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>reduction <span class="op">=</span> <span class="st">"pca"</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rerun FindVariableFeatures to increase the number before cell type deconvolution</span></span>
<span><span class="va">se_allen</span> <span class="op">&lt;-</span> <span class="va">se_allen</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>nfeatures <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code></pre></div>
<p>We can visualize the available cell types in our UMAP embedding of
the cells. We have access to 23 annotated cell types, including L2-L6
layer neurons which have a distinct spatial distribution in the
tissue.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://satijalab.org/seurat/reference/DimPlot.html" class="external-link">DimPlot</a></span><span class="op">(</span><span class="va">se_allen</span>, group.by <span class="op">=</span> <span class="st">"subclass"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="run-nnls">Run NNLS<a class="anchor" aria-label="anchor" href="#run-nnls"></a>
</h3>
<p>The <code>RunNNLS</code> method requires a normalized
<code>Seurat</code> object with 10x Visium data and a a normalized
<code>Seurat</code> object with single-cell data. The
<code>groups</code> argument defines where the cell type labels should
be taken from in the single-cell <code>Seurat</code> object. In our
single-cell <code>Seurat</code> object, the labels are stored in the
“subclass” column.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span><span class="va">se_brain_spatial</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span></span>
<span></span>
<span><span class="va">ti</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">se_brain_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/celltype-prediction.html">RunNNLS</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">se_brain_spatial</span>, </span>
<span>                            singlecell_object <span class="op">=</span> <span class="va">se_allen</span>, </span>
<span>                            groups <span class="op">=</span> <span class="st">"subclass"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Predicting cell type proportions</span> ──</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Fetching data from Seurat objects</span></span></code></pre>
<pre><code><span><span class="co">## →   Filtering out features that are only present in one data set</span></span></code></pre>
<pre><code><span><span class="co">## →   Kept 3379 features for deconvolution</span></span></code></pre>
<pre><code><span><span class="co">## Loading required namespace: RcppML</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Preparing data for NNLS</span></span></code></pre>
<pre><code><span><span class="co">## →   Downsampling scRNA-seq data to include a maximum of 50 cells per cell type</span></span></code></pre>
<pre><code><span><span class="co">## → <span style="color: #FF55FF;">  Cell type(s) CR have too few cells (&lt;10) and will be excluded</span></span></span></code></pre>
<pre><code><span><span class="co">## →   Kept 22 cell types after filtering</span></span></code></pre>
<pre><code><span><span class="co">## →   Calculating cell type expression profiles</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Predicting cell type proportions with NNLS for 22 cell types</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Returning results in a new 'Assay' named 'celltypeprops'</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Setting default assay to 'celltypeprops'</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Finished</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"RunNNLS completed in %s seconds"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">ti</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "RunNNLS completed in 2.82 seconds"</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check available cell types</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">se_brain_spatial</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "Astro"      "Endo"       "L2/3 IT"    "L4"         "L5 IT"     </span></span>
<span><span class="co">##  [6] "L5 PT"      "L6 CT"      "L6 IT"      "L6b"        "Lamp5"     </span></span>
<span><span class="co">## [11] "Macrophage" "Meis2"      "NP"         "Oligo"      "Peri"      </span></span>
<span><span class="co">## [16] "Pvalb"      "Serpinf1"   "SMC"        "Sncg"       "Sst"       </span></span>
<span><span class="co">## [21] "Vip"        "VLMC"</span></span></code></pre>
<p>NB: the CR cell type was discarded because the number of cell was
lower than 10. 10 is the lower limit for the allowed number of cells per
cell type but this can be overridden with
<code>minCells_per_celltype</code>.</p>
<p>The plots below show the spatial distributions of proportions for a
selected set of cell types.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot selected cell types</span></span>
<span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span><span class="va">se_brain_spatial</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"celltypeprops"</span></span>
<span></span>
<span><span class="va">selected_celltypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"L2/3 IT"</span>, <span class="st">"L4"</span>, <span class="st">"L5 IT"</span>, </span>
<span>                       <span class="st">"L5 PT"</span>, <span class="st">"L6 CT"</span>, <span class="st">"L6 IT"</span>, <span class="st">"L6b"</span>, </span>
<span>                       <span class="st">"Oligo"</span>, <span class="st">"Pvalb"</span>, <span class="st">"Meis2"</span>, <span class="st">"Astro"</span>,</span>
<span>                       <span class="st">"VLMC"</span>, <span class="st">"SMC"</span><span class="op">)</span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">selected_celltypes</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_brain_spatial</span>, pt_size <span class="op">=</span> <span class="fl">1.3</span>,</span>
<span>            features <span class="op">=</span> <span class="va">selected_celltypes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>            arrange_features <span class="op">=</span> <span class="st">"row"</span>, scale <span class="op">=</span> <span class="st">"shared"</span>, </span>
<span>            override_plot_dims <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="va">selected_celltypes</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_brain_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="va">se_brain_spatial</span>, image_height <span class="op">=</span> <span class="fl">1e3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Load H&amp;E images</span> ──</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Loading image from ./mousebrain/visium/S1/spatial/tissue_hires_image.png</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Scaled image from 1998x2000 to 1000x1001 pixels</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Loading image from ./mousebrain/visium/S2/spatial/tissue_hires_image.png</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Scaled image from 1998x2000 to 1000x1001 pixels</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Saving loaded H&amp;E images as 'rasters' in Seurat object</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">selected_celltypes</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_brain_spatial</span>, pt_size <span class="op">=</span> <span class="fl">1.3</span>,</span>
<span>            features <span class="op">=</span> <span class="va">selected_celltypes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, image_use <span class="op">=</span> <span class="st">"raw"</span>,</span>
<span>            arrange_features <span class="op">=</span> <span class="st">"row"</span>, scale <span class="op">=</span> <span class="st">"shared"</span>, </span>
<span>            override_plot_dims <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            colors <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">9</span>, name <span class="op">=</span> <span class="st">"Spectral"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>            scale_alpha <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="va">selected_celltypes</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3 tabset">
<h3 class="tabset" id="mouse-brain-cell-types">Mouse brain cell types<a class="anchor" aria-label="anchor" href="#mouse-brain-cell-types"></a>
</h3>













<ul class="nav nav-tabs" id="mouse-brain-cell-types" role="tablist">
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#l23-it" id="l23-it-tab" type="button" role="tab" aria-controls="l23-it" aria-selected="true" class="active nav-link">L2/3 IT</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#l4" id="l4-tab" type="button" role="tab" aria-controls="l4" aria-selected="false" class="nav-link">L4</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#l5-it" id="l5-it-tab" type="button" role="tab" aria-controls="l5-it" aria-selected="false" class="nav-link">L5 IT</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#l5-pt" id="l5-pt-tab" type="button" role="tab" aria-controls="l5-pt" aria-selected="false" class="nav-link">L5 PT</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#l6-ct" id="l6-ct-tab" type="button" role="tab" aria-controls="l6-ct" aria-selected="false" class="nav-link">L6 CT</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#l6-it" id="l6-it-tab" type="button" role="tab" aria-controls="l6-it" aria-selected="false" class="nav-link">L6 IT</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#l6b" id="l6b-tab" type="button" role="tab" aria-controls="l6b" aria-selected="false" class="nav-link">L6b</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#oligo" id="oligo-tab" type="button" role="tab" aria-controls="oligo" aria-selected="false" class="nav-link">Oligo</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#pvalb" id="pvalb-tab" type="button" role="tab" aria-controls="pvalb" aria-selected="false" class="nav-link">Pvalb</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#meis2" id="meis2-tab" type="button" role="tab" aria-controls="meis2" aria-selected="false" class="nav-link">Meis2</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#astro" id="astro-tab" type="button" role="tab" aria-controls="astro" aria-selected="false" class="nav-link">Astro</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#vlmc" id="vlmc-tab" type="button" role="tab" aria-controls="vlmc" aria-selected="false" class="nav-link">VLMC</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#smc" id="smc-tab" type="button" role="tab" aria-controls="smc" aria-selected="false" class="nav-link">SMC</button></li>
</ul>
<div class="tab-content">
<div class="active  tab-pane" id="l23-it" role="tabpanel" aria-labelledby="l23-it-tab">

<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
</div>
<div class="tab-pane" id="l4" role="tabpanel" aria-labelledby="l4-tab">

<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div class="tab-pane" id="l5-it" role="tabpanel" aria-labelledby="l5-it-tab">

<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
<div class="tab-pane" id="l5-pt" role="tabpanel" aria-labelledby="l5-pt-tab">

<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
<div class="tab-pane" id="l6-ct" role="tabpanel" aria-labelledby="l6-ct-tab">

<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
<div class="tab-pane" id="l6-it" role="tabpanel" aria-labelledby="l6-it-tab">

<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
</div>
<div class="tab-pane" id="l6b" role="tabpanel" aria-labelledby="l6b-tab">

<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">7</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
<div class="tab-pane" id="oligo" role="tabpanel" aria-labelledby="oligo-tab">

<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
<div class="tab-pane" id="pvalb" role="tabpanel" aria-labelledby="pvalb-tab">

<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">9</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
</div>
<div class="tab-pane" id="meis2" role="tabpanel" aria-labelledby="meis2-tab">

<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">10</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
</div>
<div class="tab-pane" id="astro" role="tabpanel" aria-labelledby="astro-tab">

<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">11</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
</div>
<div class="tab-pane" id="vlmc" role="tabpanel" aria-labelledby="vlmc-tab">

<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">12</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
</div>
<div class="tab-pane" id="smc" role="tabpanel" aria-labelledby="smc-tab">

<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">13</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="visualize-multiple-cell-types">Visualize multiple cell types<a class="anchor" aria-label="anchor" href="#visualize-multiple-cell-types"></a>
</h3>
<p>We can also visualize some of these cell types in one single plot
with MapMultipleFeatures.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load H&amp;E images</span></span>
<span><span class="va">se_brain_spatial</span> <span class="op">&lt;-</span> <span class="va">se_brain_spatial</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate colors</span></span>
<span></span>
<span><span class="co"># Plot multiple features</span></span>
<span><span class="fu"><a href="../reference/visualize-multiple-features.html">MapMultipleFeatures</a></span><span class="op">(</span><span class="va">se_brain_spatial</span>, </span>
<span>                    image_use <span class="op">=</span> <span class="st">"raw"</span>, </span>
<span>                    pt_size <span class="op">=</span> <span class="fl">2</span>, max_cutoff <span class="op">=</span> <span class="fl">0.99</span>,</span>
<span>                    override_plot_dims <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                    colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#332288"</span>, <span class="st">"#88CCEE"</span>, <span class="st">"#44AA99"</span>, <span class="st">"#117733"</span>, <span class="st">"#DDCC77"</span>, <span class="st">"#CC6677"</span>,<span class="st">"#AA4499"</span><span class="op">)</span>,</span>
<span>                    features <span class="op">=</span> <span class="va">selected_celltypes</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-26-1.png" width="960"></p>
</div>
</div>
<div class="section level2">
<h2 id="mouse-kidney">Mouse kidney<a class="anchor" aria-label="anchor" href="#mouse-kidney"></a>
</h2>
<p>In the second example, we’ll look at data from mouse kidney. We can
obtain the single-cell data with the <code>TabulaMurisSenisData</code> R
package from bioconductor. Let’s load the data and create a
<code>Seurat</code> object from it.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/TabulaMurisSenisData/man/TabulaMurisSenisDroplet.html" class="external-link">TabulaMurisSenisDroplet</a></span><span class="op">(</span>tissues <span class="op">=</span> <span class="st">"Kidney"</span><span class="op">)</span><span class="op">$</span><span class="va">Kidney</span></span>
<span><span class="va">umis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span>, <span class="st">"dgCMatrix"</span><span class="op">)</span></span>
<span><span class="va">se_kidney_singlecell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/CreateSeuratObject.html" class="external-link">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">umis</span>, meta.data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The 10x Visium mouse kidney data can be downloaded from the 10x
genomics website.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"/kidney"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">targetdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"/kidney"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Download section 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Kidney/V1_Mouse_Kidney_filtered_feature_bc_matrix.h5"</span>, </span>
<span>              destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/filtered_feature_bc_matrix.h5"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Kidney/V1_Mouse_Kidney_spatial.tar.gz"</span>,</span>
<span>              destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/spatial.tar.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/untar.html" class="external-link">untar</a></span><span class="op">(</span>tarfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/spatial.tar.gz"</span><span class="op">)</span>, </span>
<span>      exdir <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"/visium/spatial.tar.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="st">"./kidney/visium/filtered_feature_bc_matrix.h5"</span></span>
<span><span class="va">imgs</span> <span class="op">&lt;-</span> <span class="st">"./kidney/visium/spatial/tissue_hires_image.png"</span></span>
<span><span class="va">spotfiles</span> <span class="op">&lt;-</span> <span class="st">"./kidney/visium/spatial/tissue_positions_list.csv"</span></span>
<span><span class="va">json</span> <span class="op">&lt;-</span> <span class="st">"./kidney/visium/spatial/scalefactors_json.json"</span></span>
<span></span>
<span><span class="va">infoTable</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">imgs</span>, <span class="va">spotfiles</span>, <span class="va">json</span><span class="op">)</span></span>
<span></span>
<span><span class="va">se_kidney_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ReadVisiumData.html">ReadVisiumData</a></span><span class="op">(</span><span class="va">infoTable</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="normalize-data-1">Normalize data<a class="anchor" aria-label="anchor" href="#normalize-data-1"></a>
</h3>
<p>We apply the same normalization procedure to
<code>se_kidney_spatial</code> and <code>se_kidney_singlecell</code> and
run <code>FindVariableFeatures</code> to detect the top most variable
genes.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_kidney_spatial</span> <span class="op">&lt;-</span> <span class="va">se_kidney_spatial</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>nfeatures <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code></pre></div>
<p>For the single-cell kidney data, we’ll also filter the data prior to
normalization to include cells collected at age 18m and remove cells
with labels “nan” and “CD45”. This leaves us with 17 cell types.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">keep_cells</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">se_kidney_singlecell</span><span class="op">)</span><span class="op">[</span><span class="va">se_kidney_singlecell</span><span class="op">$</span><span class="va">age</span> <span class="op">==</span> <span class="st">"18m"</span> <span class="op">&amp;</span> <span class="op">(</span><span class="op">!</span><span class="va">se_kidney_singlecell</span><span class="op">$</span><span class="va">free_annotation</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"nan"</span>, <span class="st">"CD45"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">se_kidney_singlecell</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">se_kidney_singlecell</span>, cells <span class="op">=</span> <span class="va">keep_cells</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_kidney_singlecell</span> <span class="op">&lt;-</span> <span class="va">se_kidney_singlecell</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html" class="external-link">RunUMAP</a></span><span class="op">(</span>reduction <span class="op">=</span> <span class="st">"pca"</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="va">se_kidney_singlecell</span> <span class="op">&lt;-</span> <span class="va">se_kidney_singlecell</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span>nfeatures <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-nnls-1">Run NNLS<a class="anchor" aria-label="anchor" href="#run-nnls-1"></a>
</h3>
<p>Again, the <code>RunNNLS</code> method requires a single-cell
<code>Seurat</code> object and a 10x Visium <code>Seurat</code> object.
The cell type annotations are stored in the “free_annotation”
column.</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ti</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span><span class="va">se_kidney_spatial</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span></span>
<span><span class="va">se_kidney_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/celltype-prediction.html">RunNNLS</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">se_kidney_spatial</span>, </span>
<span>                      singlecell_object <span class="op">=</span> <span class="va">se_kidney_singlecell</span>, </span>
<span>                      groups <span class="op">=</span> <span class="st">"free_annotation"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Predicting cell type proportions</span> ──</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Fetching data from Seurat objects</span></span></code></pre>
<pre><code><span><span class="co">## →   Filtering out features that are only present in one data set</span></span></code></pre>
<pre><code><span><span class="co">## →   Kept 4993 features for deconvolution</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Preparing data for NNLS</span></span></code></pre>
<pre><code><span><span class="co">## →   Downsampling scRNA-seq data to include a maximum of 50 cells per cell type</span></span></code></pre>
<pre><code><span><span class="co">## → <span style="color: #FF55FF;">  Cell type(s) CD45    NK cell,CD45    plasma cell have too few cells (&lt;10) and will be excluded</span></span></span></code></pre>
<pre><code><span><span class="co">## →   Kept 15 cell types after filtering</span></span></code></pre>
<pre><code><span><span class="co">## →   Calculating cell type expression profiles</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Predicting cell type proportions with NNLS for 15 cell types</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Returning results in a new 'Assay' named 'celltypeprops'</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Setting default assay to 'celltypeprops'</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Finished</span></span></code></pre>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"RunNNLS finished in %s seconds"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">ti</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "RunNNLS finished in 0.54 seconds"</span></span></code></pre>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check available cell types</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">se_kidney_spatial</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "CD45    B cell"                                            </span></span>
<span><span class="co">##  [2] "CD45    macrophage"                                        </span></span>
<span><span class="co">##  [3] "CD45    T cell"                                            </span></span>
<span><span class="co">##  [4] "Epcam     kidney distal convoluted tubule epithelial cell" </span></span>
<span><span class="co">##  [5] "Epcam    brush cell"                                       </span></span>
<span><span class="co">##  [6] "Epcam    kidney collecting duct principal cell"            </span></span>
<span><span class="co">##  [7] "Epcam    kidney proximal convoluted tubule epithelial cell"</span></span>
<span><span class="co">##  [8] "Epcam    podocyte"                                         </span></span>
<span><span class="co">##  [9] "Epcam    proximal tube epithelial cell"                    </span></span>
<span><span class="co">## [10] "Epcam    thick ascending tube S epithelial cell"           </span></span>
<span><span class="co">## [11] "Pecam    fenestrated capillary endothelial"                </span></span>
<span><span class="co">## [12] "Pecam    kidney capillary endothelial cell"                </span></span>
<span><span class="co">## [13] "Pecam    Kidney cortex artery cell"                        </span></span>
<span><span class="co">## [14] "Stroma    fibroblast"                                      </span></span>
<span><span class="co">## [15] "Stroma    kidney mesangial cell"</span></span></code></pre>
<p>NB: two cell types were discarded as they didn’t pass the minimum
allowed cells per cell type threshold. The cell types discarded were NK
cells and plasma cells.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot selected cell types</span></span>
<span><span class="fu"><a href="https://mojaveazure.github.io/seurat-object/reference/DefaultAssay.html" class="external-link">DefaultAssay</a></span><span class="op">(</span><span class="va">se_kidney_spatial</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"celltypeprops"</span></span>
<span></span>
<span><span class="va">selected_celltypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Epcam     kidney distal convoluted tubule epithelial cell"</span>,</span>
<span>                        <span class="st">"Epcam    brush cell"</span>,</span>
<span>                        <span class="st">"Epcam    kidney collecting duct principal cell"</span>,</span>
<span>                        <span class="st">"Epcam    kidney proximal convoluted tubule epithelial cell"</span>,</span>
<span>                        <span class="st">"Epcam    podocyte"</span>,</span>
<span>                        <span class="st">"Epcam    proximal tube epithelial cell"</span>,</span>
<span>                        <span class="st">"Epcam    thick ascending tube S epithelial cell"</span>,</span>
<span>                        <span class="st">"Pecam    fenestrated capillary endothelial"</span>,</span>
<span>                        <span class="st">"Pecam    kidney capillary endothelial cell"</span>,</span>
<span>                        <span class="st">"Stroma    kidney mesangial cell"</span><span class="op">)</span></span>
<span><span class="va">plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">selected_celltypes</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_kidney_spatial</span>, pt_size <span class="op">=</span> <span class="fl">1.3</span>,</span>
<span>            features <span class="op">=</span> <span class="va">selected_celltypes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, </span>
<span>            override_plot_dims <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span>nm <span class="op">=</span> <span class="va">selected_celltypes</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3 tabset">
<h3 class="tabset" id="kidney-cell-types">Kidney cell types<a class="anchor" aria-label="anchor" href="#kidney-cell-types"></a>
</h3>









<ul class="nav nav-tabs" id="kidney-cell-types" role="tablist">
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#kidney-distal-convoluted-tubule-epithelial-cell" id="kidney-distal-convoluted-tubule-epithelial-cell-tab" type="button" role="tab" aria-controls="kidney-distal-convoluted-tubule-epithelial-cell" aria-selected="true" class="active nav-link">kidney distal convoluted tubule epithelial cell</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#brush-cell" id="brush-cell-tab" type="button" role="tab" aria-controls="brush-cell" aria-selected="false" class="nav-link">brush cell</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#kidney-collecting-duct-principal-cell" id="kidney-collecting-duct-principal-cell-tab" type="button" role="tab" aria-controls="kidney-collecting-duct-principal-cell" aria-selected="false" class="nav-link">kidney collecting duct principal cell</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#podocyte" id="podocyte-tab" type="button" role="tab" aria-controls="podocyte" aria-selected="false" class="nav-link">podocyte</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#proximal-tube-epithelial-cell" id="proximal-tube-epithelial-cell-tab" type="button" role="tab" aria-controls="proximal-tube-epithelial-cell" aria-selected="false" class="nav-link">proximal tube epithelial cell</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#thick-ascending-tube-s-epithelial-cell" id="thick-ascending-tube-s-epithelial-cell-tab" type="button" role="tab" aria-controls="thick-ascending-tube-s-epithelial-cell" aria-selected="false" class="nav-link">thick ascending tube S epithelial cell</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#fenestrated-capillary-endothelial" id="fenestrated-capillary-endothelial-tab" type="button" role="tab" aria-controls="fenestrated-capillary-endothelial" aria-selected="false" class="nav-link">fenestrated capillary endothelial</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#kidney-capillary-endothelial-cell" id="kidney-capillary-endothelial-cell-tab" type="button" role="tab" aria-controls="kidney-capillary-endothelial-cell" aria-selected="false" class="nav-link">kidney capillary endothelial cell</button></li>
<li role="presentation" class="nav-item"><button data-bs-toggle="tab" data-bs-target="#kidney-mesangial-cell" id="kidney-mesangial-cell-tab" type="button" role="tab" aria-controls="kidney-mesangial-cell" aria-selected="false" class="nav-link">kidney mesangial cell</button></li>
</ul>
<div class="tab-content">
<div class="active  tab-pane" id="kidney-distal-convoluted-tubule-epithelial-cell" role="tabpanel" aria-labelledby="kidney-distal-convoluted-tubule-epithelial-cell-tab">

<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-35-1.png" width="700"></p>
</div>
<div class="tab-pane" id="brush-cell" role="tabpanel" aria-labelledby="brush-cell-tab">

<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-36-1.png" width="700"></p>
</div>
<div class="tab-pane" id="kidney-collecting-duct-principal-cell" role="tabpanel" aria-labelledby="kidney-collecting-duct-principal-cell-tab">

<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-37-1.png" width="700"></p>
</div>
<div class="tab-pane" id="podocyte" role="tabpanel" aria-labelledby="podocyte-tab">

<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-38-1.png" width="700"></p>
</div>
<div class="tab-pane" id="proximal-tube-epithelial-cell" role="tabpanel" aria-labelledby="proximal-tube-epithelial-cell-tab">

<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">5</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-39-1.png" width="700"></p>
</div>
<div class="tab-pane" id="thick-ascending-tube-s-epithelial-cell" role="tabpanel" aria-labelledby="thick-ascending-tube-s-epithelial-cell-tab">

<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">6</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-40-1.png" width="700"></p>
</div>
<div class="tab-pane" id="fenestrated-capillary-endothelial" role="tabpanel" aria-labelledby="fenestrated-capillary-endothelial-tab">

<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">7</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-41-1.png" width="700"></p>
</div>
<div class="tab-pane" id="kidney-capillary-endothelial-cell" role="tabpanel" aria-labelledby="kidney-capillary-endothelial-cell-tab">

<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-42-1.png" width="700"></p>
</div>
<div class="tab-pane" id="kidney-mesangial-cell" role="tabpanel" aria-labelledby="kidney-mesangial-cell-tab">

<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plots</span><span class="op">[[</span><span class="fl">9</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-43-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="visualize-multiple-cell-types-1">Visualize multiple cell types<a class="anchor" aria-label="anchor" href="#visualize-multiple-cell-types-1"></a>
</h3>
<p>We can select some of these cell types and visualize them in one
plot</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load H&amp;E images</span></span>
<span><span class="va">se_kidney_spatial</span> <span class="op">&lt;-</span> <span class="va">se_kidney_spatial</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate colors</span></span>
<span></span>
<span><span class="co"># Plot multiple features</span></span>
<span><span class="fu"><a href="../reference/visualize-multiple-features.html">MapMultipleFeatures</a></span><span class="op">(</span><span class="va">se_kidney_spatial</span>, </span>
<span>                    image_use <span class="op">=</span> <span class="st">"raw"</span>, </span>
<span>                    pt_size <span class="op">=</span> <span class="fl">2</span>, max_cutoff <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                    override_plot_dims <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                    colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#332288"</span>, <span class="st">"#88CCEE"</span>, <span class="st">"#117733"</span>, <span class="st">"#DDCC77"</span>, <span class="st">"#CC6677"</span>,<span class="st">"#AA4499"</span><span class="op">)</span>,</span>
<span>                    features <span class="op">=</span> <span class="va">selected_celltypes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">7</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-45-1.png" width="960"></p>
<p>Or zoom in on a region of interest</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reload H&amp;E image in higher resolution</span></span>
<span><span class="va">se_kidney_spatial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="va">se_kidney_spatial</span>, image_height <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot H&amp;E image</span></span>
<span><span class="va">rst</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetImages.html">GetImages</a></span><span class="op">(</span><span class="va">se_kidney_spatial</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"H&amp;E image of zoomed in area"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/inset_element.html" class="external-link">inset_element</a></span><span class="op">(</span>p <span class="op">=</span> <span class="va">rst</span><span class="op">[</span><span class="op">(</span><span class="fl">0.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">rst</span><span class="op">)</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">0.7</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">rst</span><span class="op">)</span><span class="op">)</span>, <span class="op">(</span><span class="fl">0.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">rst</span><span class="op">)</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fl">0.7</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">rst</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, </span>
<span>                left <span class="op">=</span> <span class="fl">0</span>, bottom <span class="op">=</span> <span class="fl">0</span>, right <span class="op">=</span> <span class="fl">1</span>, top <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot multiple features with zoom</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/visualize-multiple-features.html">MapMultipleFeatures</a></span><span class="op">(</span><span class="va">se_kidney_spatial</span>, </span>
<span>                    image_use <span class="op">=</span> <span class="st">"raw"</span>, </span>
<span>                    pt_size <span class="op">=</span> <span class="fl">4.5</span>, max_cutoff <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>                    crop_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>                    colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#332288"</span>, <span class="st">"#88CCEE"</span>, <span class="st">"#117733"</span>, <span class="st">"#DDCC77"</span>, <span class="st">"#CC6677"</span>,<span class="st">"#AA4499"</span><span class="op">)</span>,</span>
<span>                    features <span class="op">=</span> <span class="va">selected_celltypes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">7</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">/</span> <span class="va">p2</span></span></code></pre></div>
<p><img src="cell_type_mapping_with_NNLS_files/figure-html/unnamed-chunk-46-1.png" width="960"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/ludvigla" class="external-link">Ludvig Larsson</a>, <a href="https://github.com/lfranzen" class="external-link">Lovisa Franzen</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
