<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="semla">
<title>Mask images • semla</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Mask images">
<meta property="og:description" content="semla">
<meta property="og:image" content="https://ludvigla.github.io/semla/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">semla</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/semla.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tutorials">Tutorials</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tutorials">
    <h6 class="dropdown-header" data-toc-skip>Intro</h6>
    <a class="dropdown-item" href="../articles/getting_started.html">Get started</a>
    <a class="dropdown-item" href="../articles/subset_and_merge.html">Subset/merge</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Interactive</h6>
    <a class="dropdown-item" href="../articles/feature_viewer.html">Feature viewer</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial visualization</h6>
    <a class="dropdown-item" href="../articles/numeric_features.html">Map numeric features</a>
    <a class="dropdown-item" href="../articles/categorical_features.html">Map categorical features</a>
    <a class="dropdown-item" href="../articles/advanced_visualization.html">Advanced visualization</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial methods</h6>
    <a class="dropdown-item" href="../articles/radial_distances.html">Radial distances</a>
    <a class="dropdown-item" href="../articles/region_neighbors.html">Region neighbors</a>
    <a class="dropdown-item" href="../articles/spatial_statistics_for_labelled_spots.html">Statistics for labelled spots</a>
    <a class="dropdown-item" href="../articles/spatial_autocorrelation.html">Spatial autocorrelation</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Analysis</h6>
    <a class="dropdown-item" href="../articles/cell_type_mapping_with_NNLS.html">Cell type mapping</a>
    <a class="dropdown-item" href="../articles/digital_unrolling.html">Digital unrolling</a>
    <a class="dropdown-item" href="../articles/NNMF.html">Non-negative Matrix Factorization</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Image processing</h6>
    <a class="dropdown-item" href="../articles/images_and_coordinates.html">Images and spot coordinates</a>
    <a class="dropdown-item" href="../articles/mask_images.html">Image masking</a>
    <a class="dropdown-item" href="../articles/image_alignment.html">Image alignment</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ludvigla/semla" aria-label="GitHub">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Mask images</h1>
            
            <h4 data-toc-skip class="date">Last compiled: 23 February
2023</h4>
      
      
      <div class="d-none name"><code>mask_images.Rmd</code></div>
    </div>

    
    
<p>Here we’ll have a quick look at how you can mask H&amp;E images with
<code>semla</code>. Masking means removing the background from the
tissue section and is mostly useful for aesthetic purposes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ludvigla.github.io/semla/">semla</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/magick/" class="external-link">magick</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="load-data">Load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h2>
<p>First we need to load some 10x Visium data. here we’ll use a mouse
brain tissue dataset and a mouse colon dataset that are shipped with
semla.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load data</span></span>
<span><span class="va">se_mbrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, </span>
<span>                                        <span class="st">"mousebrain/se_mbrain"</span>, </span>
<span>                                        package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">se_mbrain</span><span class="op">$</span><span class="va">sample_id</span> <span class="op">&lt;-</span> <span class="st">"mousebrain"</span></span>
<span><span class="va">se_mcolon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, </span>
<span>                                        <span class="st">"mousecolon/se_mcolon"</span>, </span>
<span>                                        package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">se_mcolon</span><span class="op">$</span><span class="va">sample_id</span> <span class="op">&lt;-</span> <span class="st">"mousecolon"</span></span>
<span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge.html">MergeSTData</a></span><span class="op">(</span><span class="va">se_mbrain</span>, <span class="va">se_mcolon</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>When we plot the H&amp;E images, we can see that the entire capture
area is shown, including the fiducials (the dots that marks the edges of
the capture area).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_merged</span><span class="op">)</span></span></code></pre></div>
<p><img src="mask_images_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="mask-images">Mask images<a class="anchor" aria-label="anchor" href="#mask-images"></a>
</h2>
<p><code>MaskImages</code> makes it possible to remove the
background:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="va">se_merged</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/mask-images.html">MaskImages</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/ImagePlot.html">ImagePlot</a></span><span class="op">(</span><span class="va">se_merged</span><span class="op">)</span></span></code></pre></div>
<p><img src="mask_images_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>When masking H&amp;E images in a <code>Seurat</code> object created
with <code>semla</code>, the “raw” image is replaced, meaning that plot
functions such as <code>MapFeatures</code> and <code>MapLabels</code>
will now use the masked image instead.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_merged</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Th"</span>, <span class="st">"Il22ra2"</span><span class="op">)</span>, image_use <span class="op">=</span> <span class="st">"raw"</span>, </span>
<span>            override_plot_dims <span class="op">=</span> <span class="cn">TRUE</span>, colors <span class="op">=</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">9</span>, name <span class="op">=</span> <span class="st">"Spectral"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="mask_images_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>If you want to use the original H&amp;E images, you can simply reload
them with <code>LoadImages</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reload images from source files</span></span>
<span><span class="va">se_merged</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="va">se_merged</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="notes-about-he-masking">Notes about H&amp;E masking<a class="anchor" aria-label="anchor" href="#notes-about-he-masking"></a>
</h2>
<p>Masking is not always a trivial task and <code>MaskImages</code>
might fail, in particular when faced with one of the following
issues:</p>
<ul>
<li><p>presence of staining artefacts</p></li>
<li><p>when using other stains than H&amp;E</p></li>
<li><p>presence of bubbles or other types of speckles/dust</p></li>
<li><p>tissues with low contrast to background, e.g. adipose
tissue</p></li>
<li><p>if the image is loaded in high resolution</p></li>
</ul>
<div class="section level3">
<h3 id="custom-masking-advanced">Custom masking (advanced)<a class="anchor" aria-label="anchor" href="#custom-masking-advanced"></a>
</h3>
<p>If <code>MaskImages</code> fails, it is possible to mask the images
manually, but this requires some knowledge about image processing. Below
is a simple example of how one can mask the mouse brain tissue section
using the <code>magick</code> R package:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fetch H&amp;E rasters </span></span>
<span><span class="va">mcolon_rasters</span> <span class="op">&lt;-</span> <span class="va">se_mcolon</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/load-images.html">LoadImages</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/GetImages.html">GetImages</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load image as a magick-image object</span></span>
<span><span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html" class="external-link">image_read</a></span><span class="op">(</span><span class="va">mcolon_rasters</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert image to CMYK colorspace and extract the magenta channel</span></span>
<span><span class="va">im_magenta</span> <span class="op">&lt;-</span> <span class="va">image</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html" class="external-link">image_convert</a></span><span class="op">(</span>colorspace <span class="op">=</span> <span class="st">"cmyk"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html" class="external-link">image_channel</a></span><span class="op">(</span>channel <span class="op">=</span> <span class="st">"Magenta"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add blur effect to image and threshold image</span></span>
<span><span class="va">im_threshold</span> <span class="op">&lt;-</span> <span class="va">im_magenta</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/effects.html" class="external-link">image_blur</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/thresholding.html" class="external-link">image_threshold</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"black"</span>, threshold <span class="op">=</span> <span class="st">"20%"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/thresholding.html" class="external-link">image_threshold</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"white"</span>, threshold <span class="op">=</span> <span class="st">"20%"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Mask H&amp;E by combining H&amp;E image with mask</span></span>
<span><span class="va">mask</span> <span class="op">&lt;-</span> <span class="va">im_threshold</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/color.html" class="external-link">image_transparent</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span><span class="va">im_composite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/composite.html" class="external-link">image_composite</a></span><span class="op">(</span><span class="va">mask</span>, <span class="va">image</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot images</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">image</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"H&amp;E image"</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">im_magenta</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Magenta color channel"</span>, col.main <span class="op">=</span> <span class="st">"white"</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">im_threshold</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Image mask"</span>, col.main <span class="op">=</span> <span class="st">"white"</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">im_composite</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Masked H&amp;E image"</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="mask_images_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The results are not perfect because there are still a few speckles in
the background and some parts of the tissue section are masked. But even
a simple approach like this can give decent results!</p>
<p>The processing was done using the R package <code>magick</code> and
with this package you should be able to manipulate images to get pretty
much any result you want. The package vignette is a good resource to get
started: <a href="https://cran.r-project.org/web/packages/magick/vignettes/intro.html" class="external-link">magick
intro</a></p>
<p>Once you have masked the image, you can convert it back to a
<code>raster</code> object and place it into your <code>Seurat</code>
object. Now we are only working with 1 tissue section, but if you have
multiple tissue sections you need to make sure that the list of
<code>raster</code> objects contains 1 image per sample in the correct
order.</p>
<p>Also, you cannot adjust the dimensions of the image!!! They have to
have exactly the same dimensions as the images that you started with
otherwise, the spots will no longer be aligned properly.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se_mcolon</span><span class="op">@</span><span class="va">tools</span><span class="op">$</span><span class="va">Staffli</span><span class="op">@</span><span class="va">rasterlists</span><span class="op">$</span><span class="va">raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="va">im_composite</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/visualize-features.html">MapFeatures</a></span><span class="op">(</span><span class="va">se_mcolon</span>, features <span class="op">=</span> <span class="st">"nFeature_Spatial"</span>, image_use <span class="op">=</span> <span class="st">"raw"</span>, </span>
<span>            pt_alpha <span class="op">=</span> <span class="fl">0.5</span>, pt_size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="mask_images_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p><br></p>
<hr>
<details open><summary><strong>Package version</strong>
</summary><ul>
<li>
<code>semla</code>: 0.1.0</li>
</ul></details><details><summary><strong>Session info</strong>
</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.2.1 (2022-06-23)</span></span>
<span><span class="co">## Platform: x86_64-apple-darwin13.4.0 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Big Sur ... 10.16</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS/LAPACK: /Users/ludviglarsson/miniconda3/envs/R4.2/lib/libopenblasp-r0.3.21.dylib</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] magick_2.7.3       semla_0.1.0        ggplot2_3.3.6      dplyr_1.0.9       </span></span>
<span><span class="co">## [5] SeuratObject_4.1.3 Seurat_4.3.0      </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] Rtsne_0.16             colorspace_2.0-3       deldir_1.0-6          </span></span>
<span><span class="co">##   [4] ellipsis_0.3.2         ggridges_0.5.3         rprojroot_2.0.3       </span></span>
<span><span class="co">##   [7] fs_1.5.2               spatstat.data_3.0-0    rstudioapi_0.14       </span></span>
<span><span class="co">##  [10] farver_2.1.1           leiden_0.4.2           listenv_0.8.0         </span></span>
<span><span class="co">##  [13] ggrepel_0.9.1          fansi_1.0.3            codetools_0.2-18      </span></span>
<span><span class="co">##  [16] splines_4.2.1          cachem_1.0.6           knitr_1.39            </span></span>
<span><span class="co">##  [19] zeallot_0.1.0          polyclip_1.10-0        jsonlite_1.8.3        </span></span>
<span><span class="co">##  [22] ica_1.0-3              cluster_2.1.4          png_0.1-7             </span></span>
<span><span class="co">##  [25] uwot_0.1.14            spatstat.sparse_3.0-0  shiny_1.7.4           </span></span>
<span><span class="co">##  [28] sctransform_0.3.5      compiler_4.2.1         httr_1.4.4            </span></span>
<span><span class="co">##  [31] assertthat_0.2.1       Matrix_1.5-3           fastmap_1.1.0         </span></span>
<span><span class="co">##  [34] lazyeval_0.2.2         cli_3.4.1              later_1.3.0           </span></span>
<span><span class="co">##  [37] htmltools_0.5.4        tools_4.2.1            igraph_1.3.4          </span></span>
<span><span class="co">##  [40] gtable_0.3.0           glue_1.6.2             RANN_2.6.1            </span></span>
<span><span class="co">##  [43] reshape2_1.4.4         Rcpp_1.0.9             scattermore_0.8       </span></span>
<span><span class="co">##  [46] jquerylib_0.1.4        pkgdown_2.0.6          vctrs_0.5.1           </span></span>
<span><span class="co">##  [49] nlme_3.1-159           spatstat.explore_3.0-5 progressr_0.10.1      </span></span>
<span><span class="co">##  [52] lmtest_0.9-40          spatstat.random_3.0-1  xfun_0.32             </span></span>
<span><span class="co">##  [55] stringr_1.4.1          globals_0.16.0         mime_0.12             </span></span>
<span><span class="co">##  [58] miniUI_0.1.1.1         lifecycle_1.0.3        irlba_2.3.5           </span></span>
<span><span class="co">##  [61] goftest_1.2-3          future_1.27.0          MASS_7.3-58.1         </span></span>
<span><span class="co">##  [64] zoo_1.8-10             scales_1.2.1           spatstat.utils_3.0-1  </span></span>
<span><span class="co">##  [67] ragg_1.2.2             promises_1.2.0.1       parallel_4.2.1        </span></span>
<span><span class="co">##  [70] RColorBrewer_1.1-3     yaml_2.3.5             memoise_2.0.1         </span></span>
<span><span class="co">##  [73] reticulate_1.26        pbapply_1.5-0          gridExtra_2.3         </span></span>
<span><span class="co">##  [76] sass_0.4.2             stringi_1.7.8          highr_0.9             </span></span>
<span><span class="co">##  [79] desc_1.4.1             rlang_1.0.6            pkgconfig_2.0.3       </span></span>
<span><span class="co">##  [82] systemfonts_1.0.4      matrixStats_0.62.0     evaluate_0.16         </span></span>
<span><span class="co">##  [85] lattice_0.20-45        tensor_1.5             ROCR_1.0-11           </span></span>
<span><span class="co">##  [88] purrr_0.3.4            labeling_0.4.2         patchwork_1.1.2       </span></span>
<span><span class="co">##  [91] htmlwidgets_1.5.4      cowplot_1.1.1          tidyselect_1.1.2      </span></span>
<span><span class="co">##  [94] parallelly_1.32.1      RcppAnnoy_0.0.19       plyr_1.8.7            </span></span>
<span><span class="co">##  [97] magrittr_2.0.3         R6_2.5.1               generics_0.1.3        </span></span>
<span><span class="co">## [100] DBI_1.1.3              withr_2.5.0            pillar_1.8.1          </span></span>
<span><span class="co">## [103] fitdistrplus_1.1-8     abind_1.4-5            survival_3.4-0        </span></span>
<span><span class="co">## [106] sp_1.5-1               tibble_3.1.8           future.apply_1.9.0    </span></span>
<span><span class="co">## [109] KernSmooth_2.23-20     utf8_1.2.2             spatstat.geom_3.0-3   </span></span>
<span><span class="co">## [112] plotly_4.10.0          rmarkdown_2.15         grid_4.2.1            </span></span>
<span><span class="co">## [115] data.table_1.14.2      forcats_0.5.2          digest_0.6.29         </span></span>
<span><span class="co">## [118] xtable_1.8-4           dbscan_1.1-10          tidyr_1.2.0           </span></span>
<span><span class="co">## [121] httpuv_1.6.5           textshaping_0.3.6      munsell_0.5.0         </span></span>
<span><span class="co">## [124] viridisLite_0.4.1      bslib_0.4.0            shinyjs_2.1.0</span></span></code></pre>
</details><p><br></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/ludvigla" class="external-link">Ludvig Larsson</a>, <a href="https://github.com/lfranzen" class="external-link">Lovisa Franzen</a>, <a href="https://www.spatialresearch.org/" class="external-link"><img src="reference/figures/sr-logo.png" height="36" alt="spatialresearch"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
