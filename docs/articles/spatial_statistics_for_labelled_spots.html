<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="semla">
<title>Spatial statistics for labelled spots • semla</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Spatial statistics for labelled spots">
<meta property="og:description" content="semla">
<meta property="og:image" content="https://ludvigla.github.io/semla/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">semla</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/semla.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tutorials">Tutorials</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tutorials">
    <h6 class="dropdown-header" data-toc-skip>Intro</h6>
    <a class="dropdown-item" href="../articles/getting_started.html">Get started</a>
    <a class="dropdown-item" href="../articles/subset_and_merge.html">Subset/merge</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Interactive</h6>
    <a class="dropdown-item" href="../articles/feature_viewer.html">Feature viewer</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial visualization</h6>
    <a class="dropdown-item" href="../articles/numeric_features.html">Map numeric features</a>
    <a class="dropdown-item" href="../articles/categorical_features.html">Map categorical features</a>
    <a class="dropdown-item" href="../articles/advanced_visualization.html">Advanced visualization</a>
    <a class="dropdown-item" href="../articles/scalebar.html">Scalebar</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial methods</h6>
    <a class="dropdown-item" href="../articles/radial_distances.html">Radial distances</a>
    <a class="dropdown-item" href="../articles/region_neighbors.html">Region neighbors</a>
    <a class="dropdown-item" href="../articles/spatial_statistics_for_labelled_spots.html">Statistics for labelled spots</a>
    <a class="dropdown-item" href="../articles/spatial_autocorrelation.html">Spatial autocorrelation</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Analysis</h6>
    <a class="dropdown-item" href="../articles/cell_type_mapping_with_NNLS.html">Cell type mapping</a>
    <a class="dropdown-item" href="../articles/digital_unrolling.html">Digital unrolling</a>
    <a class="dropdown-item" href="../articles/NNMF.html">Non-negative Matrix Factorization</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Image processing</h6>
    <a class="dropdown-item" href="../articles/images_and_coordinates.html">Images and spot coordinates</a>
    <a class="dropdown-item" href="../articles/mask_images.html">Image masking</a>
    <a class="dropdown-item" href="../articles/image_alignment.html">Image alignment</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ludvigla/semla" aria-label="GitHub">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="spatial_statistics_for_labelled_spots_files/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="spatial_statistics_for_labelled_spots_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="spatial_statistics_for_labelled_spots_files/datatables-binding-0.26/datatables.js"></script><link href="spatial_statistics_for_labelled_spots_files/dt-core-1.12.1/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="spatial_statistics_for_labelled_spots_files/dt-core-1.12.1/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="spatial_statistics_for_labelled_spots_files/dt-core-1.12.1/js/jquery.dataTables.min.js"></script><link href="spatial_statistics_for_labelled_spots_files/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="spatial_statistics_for_labelled_spots_files/crosstalk-1.2.0/js/crosstalk.min.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Spatial statistics for labelled spots</h1>
            
            <h4 data-toc-skip class="date">Last compiled: 21 March
2023</h4>
      
      
      <div class="d-none name"><code>spatial_statistics_for_labelled_spots.Rmd</code></div>
    </div>

    
    
<p>In this tutorial, we will continue to analyze the spatial
relationships in Visium data, specifically describing how spots that
have been clustered, i.e. labelled, are organized. We will take
advantage of a few methods from graph theory to describe
<strong>1</strong>) if a cluster displays an aggregated or dispersed
spatial pattern using an <a href="#lat">assortativity test</a>, and
<strong>2</strong>) if two clusters co-localize spatially by calculating
<a href="#net">neighborhood enrichment</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ludvigla.github.io/semla/">semla</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nanx.me/ggsci/" class="external-link">ggsci</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT" class="external-link">DT</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="demo-data">Demo data<a class="anchor" aria-label="anchor" href="#demo-data"></a>
</h2>
<p>For this tutorial we will use a data set from mouse kidney, available
for download from 10x Genomics. This tissue section has an interesting
organization to it, which we might want to be able to describe in a more
statistical fashion.</p>
<p>After loading the data, we will quickly process the data and generate
clusters using Seurat’s <code><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors()</a></code> and
<code><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters()</a></code> based on PCA.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set up folders for storing data</span></span>
<span><span class="va">tmpdir</span> <span class="op">&lt;-</span> <span class="st">"."</span> <span class="co"># Set current wd or change to tmpdir()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"/demo_data"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"/demo_data/kidney"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">targetdir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"/demo_data/kidney/visium"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">targetdir</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Kidney/V1_Mouse_Kidney_filtered_feature_bc_matrix.h5"</span>,</span>
<span>              destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"filtered_feature_bc_matrix.h5"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span>url <span class="op">=</span> <span class="st">"https://cf.10xgenomics.com/samples/spatial-exp/1.1.0/V1_Mouse_Kidney/V1_Mouse_Kidney_spatial.tar.gz"</span>,</span>
<span>              destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"spatial.tar.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/untar.html" class="external-link">untar</a></span><span class="op">(</span>tarfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"spatial.tar.gz"</span><span class="op">)</span>,</span>
<span>      exdir <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">targetdir</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"spatial.tar.gz"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Read data</span></span>
<span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"filtered_feature_bc_matrix.h5"</span><span class="op">)</span></span>
<span><span class="va">imgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"spatial"</span>, <span class="st">"tissue_hires_image.png"</span><span class="op">)</span></span>
<span><span class="va">spotfiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"spatial"</span>, <span class="st">"tissue_positions_list.csv"</span><span class="op">)</span></span>
<span><span class="va">json</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">targetdir</span>, <span class="st">"spatial"</span>, <span class="st">"scalefactors_json.json"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">infoTable</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">imgs</span>, <span class="va">spotfiles</span>, <span class="va">json</span><span class="op">)</span></span>
<span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ReadVisiumData.html">ReadVisiumData</a></span><span class="op">(</span><span class="va">infoTable</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Reading 10x Visium data</span> ──</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Loading matrices:</span></span></code></pre>
<pre><code><span><span class="co">## →   Finished loading expression matrix 1</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> only 1 expression matrix loaded.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span>   There are <span style="color: #5555FF;">32285</span> features and <span style="color: #FF55FF;">1438</span> spots in the matrix.</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Loading coordinates:</span></span></code></pre>
<pre><code><span><span class="co">## →   Finished loading coordinates for sample 1</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Collected coordinates for <span style="color: #FF55FF;">1438</span> spots.</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── Creating `Seurat` object</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Expression matrices and coordinates are compatible</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Created `Seurat` object</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Created `Staffli` object</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Returning a `Seurat` object with <span style="color: #5555FF;">32285</span> features and <span style="color: #FF55FF;">1438</span> spots</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate clusters</span></span>
<span><span class="va">se</span> <span class="op">&lt;-</span> <span class="va">se</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html" class="external-link">NormalizeData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html" class="external-link">ScaleData</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html" class="external-link">FindVariableFeatures</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html" class="external-link">RunPCA</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html" class="external-link">FindNeighbors</a></span><span class="op">(</span>reduction <span class="op">=</span> <span class="st">"pca"</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html" class="external-link">FindClusters</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Centering and scaling data matrix</span></span></code></pre>
<pre><code><span><span class="co">## Computing nearest neighbor graph</span></span></code></pre>
<pre><code><span><span class="co">## Computing SNN</span></span></code></pre>
<pre><code><span><span class="co">## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of nodes: 1438</span></span>
<span><span class="co">## Number of edges: 48160</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Running Louvain algorithm...</span></span>
<span><span class="co">## Maximum modularity in 10 random starts: 0.7913</span></span>
<span><span class="co">## Number of communities: 11</span></span>
<span><span class="co">## Elapsed time: 0 seconds</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unique_clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">se</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span></span>
<span><span class="va">cluster_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu">ggsci</span><span class="fu">::</span><span class="fu"><a href="https://nanx.me/ggsci/reference/pal_d3.html" class="external-link">pal_d3</a></span><span class="op">(</span><span class="st">"category20"</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unique_clusters</span><span class="op">)</span><span class="op">)</span>, nm <span class="op">=</span> <span class="va">unique_clusters</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/MapLabelsSummary.html">MapLabelsSummary</a></span><span class="op">(</span><span class="va">se</span>, </span>
<span>                 column_name <span class="op">=</span> <span class="st">"seurat_clusters"</span>, </span>
<span>                 bar_display <span class="op">=</span> <span class="st">"count"</span>,</span>
<span>                 pt_size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                 override_plot_dims <span class="op">=</span> <span class="cn">T</span>, </span>
<span>                 bar_label_size <span class="op">=</span> <span class="fl">2.5</span>, </span>
<span>                 colors <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p><br></p>
<p>Looking at the clusters we just generated we can see that many of
them seem to follow some kind of spatial pattern. Cluster 1 is
dominating in the center of the tissue section, forming a core (the
medulla), while for instance clusters 0, 2, 3 are intermingled in the
cortical area of the section. To describe how these spatial clusters
behave and relate to each other, we can use a couple of analyses within
<code>semla</code> called <code><a href="../reference/label-assortativity.html">RunLabelAssortativityTest()</a></code> and
<code><a href="../reference/neighborhood-enrichment.html">RunNeighborhoodEnrichmentTest()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="visium-data-as-a-network">Visium data as a network<a class="anchor" aria-label="anchor" href="#visium-data-as-a-network"></a>
</h2>
<p>The spots in spatial data can be viewed as a network, by connecting
each spot to its closest neighbors. In Visium, the spots form hexagonal
patterns, and thus each spot can be connected to a maximum of six
neighboring spots, if we only look at the area in its direct vicinity.
In network science, a spot is referred to as a <i>node</i>, the
connection between nodes are called <i>edges</i>, and the number of
edges a node has to other nodes is described as that node’s
<i>degree</i> (<i>k</i>).</p>
<p>We can create a network from the Visium data by using the function
<code><a href="../reference/get-network.html">GetSpatialNetwork()</a></code>. This function returns a list (one
table per sample), so we’ll need to fetch the first item of the list.
Then we can add information about clusters before plotting it with
<code>ggplot2</code>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spatial_network</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get-network.html">GetSpatialNetwork</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">se</span><span class="op">$</span><span class="va">random_clusters</span> <span class="op">&lt;-</span> <span class="va">se</span><span class="op">$</span><span class="va">seurat_clusters</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">se</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">spatial_network</span><span class="op">$</span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="va">se</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">spatial_network</span><span class="op">$</span><span class="va">from</span>, <span class="st">"seurat_clusters"</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">spatial_network</span><span class="op">$</span><span class="va">random_clusters</span> <span class="op">&lt;-</span> <span class="va">se</span><span class="op">[[</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">spatial_network</span><span class="op">$</span><span class="va">from</span>, <span class="st">"random_clusters"</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 4 × 10</span></span></span>
<span><span class="co">##   from           to    dista…¹    nn x_start y_start x_end y_end cluster rando…²</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> AAACCGTTCGTCC… AACT…    138.     6    <span style="text-decoration: underline;">4</span>116    <span style="text-decoration: underline;">7</span>307  <span style="text-decoration: underline;">4</span>047  <span style="text-decoration: underline;">7</span>426 2       2      </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> AAACCTAAGCAGC… CAGG…    137.     6    <span style="text-decoration: underline;">6</span>932    <span style="text-decoration: underline;">8</span>873  <span style="text-decoration: underline;">7</span>069  <span style="text-decoration: underline;">8</span>874 5       4      </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> AAACGAGACGGTT… AAGA…    137      6    <span style="text-decoration: underline;">6</span>669    <span style="text-decoration: underline;">5</span>280  <span style="text-decoration: underline;">6</span>532  <span style="text-decoration: underline;">5</span>280 6       0      </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> AAACGGTTGCGAA… ATCT…    137      6    <span style="text-decoration: underline;">5</span>279    <span style="text-decoration: underline;">9</span>107  <span style="text-decoration: underline;">5</span>142  <span style="text-decoration: underline;">9</span>107 3       8      </span></span>
<span><span class="co">## <span style="color: #949494;"># … with abbreviated variable names ¹​distance, ²​random_clusters</span></span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span>, color<span class="op">=</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Spatial network"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span>, plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="lat">Label Assortativity Analysis<a class="anchor" aria-label="anchor" href="#lat"></a>
</h2>
<p>The term <i>assortativity</i> is used within network science to
describe how nodes of similar properties are connected to each other.
Traditionally this is looked at in terms of the node’s degree and
computing a correlation coefficient between nodes of similar degrees. A
few methods to look at this is Newman’s Assortativity (<a href="https://doi.org/10.1103/PhysRevLett.89.208701" class="external-link">Newman, 2002</a>)
and Ripley’s Function (<a href="https://doi.org/10.2307/3212829" class="external-link">Ripley,
1976</a>).</p>
<p>Inspired by this, we have developed a simple method to measure the
connectivity of spots belonging to the same cluster, i.e. sharing the
same label, by measuring the network’s average degree, ⟨k⟩, for each
label and comparing this to a completely randomly dispersed pattern. The
randomly distributed pattern can be viewed as the baseline, since we
rarely obtain a pattern more dispersed than that, while a group of spots
that is fully connected with each other is the highest order of
organization we can achieve. In this method, each label’s ⟨k⟩ is
therefore min-max scaled between the ⟨k⟩ of a randomized network
(<i>min</i>) and the ⟨k⟩ of the fully connected network
(<i>max</i>).</p>
<div class="section level3">
<h3 id="kidney-data-assortativity">Kidney data assortativity<a class="anchor" aria-label="anchor" href="#kidney-data-assortativity"></a>
</h3>
<p>We run the analysis by calling the function
<code><a href="../reference/label-assortativity.html">RunLabelAssortativityTest()</a></code> and storing the results in a
new object.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/label-assortativity.html">RunLabelAssortativityTest</a></span><span class="op">(</span><span class="va">se</span>, column_name <span class="op">=</span> <span class="st">"seurat_clusters"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Running Label Assortativity Test</span> ──</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Generating neighborhood adjacency data from observed labels in column 'seurat_clusters'</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Observed label average degree calculations complete</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Generating neighborhood adjacency data from randomized labels</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Randomized label adjacency calculations complete from 100 iterations</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> The standard deviation of some of the permuted results is relatively high (&gt;0.1) which may indicate unreliable results.</span></span>
<span><span class="co">## A possible solution could be to increase the number of permutations ('n_permutations').</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Scores calculated for each label and returned as output tibble</span></span></code></pre>
<p><br></p>
<p>The output from this analysis is tibble containing a scaled average
degree, <code>avg_k_scaled</code>, for each unique label provided for
the analysis. We can also read out the intermediates from the analyses
which were used for the calculations of the final score. The
<code>avg_k_scaled</code> goes from ~0-1, with values around 0 being
equal to a randomly dispersed spatial pattern and values closer to 1
indicating an aggregated and highly connected organization of the spots
of that label.</p>
<p>Let’s have a look at the results!</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span></span>
<span>  <span class="va">res_lat</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">avg_k_scaled</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  rownames <span class="op">=</span> <span class="cn">F</span>,</span>
<span>  caption <span class="op">=</span> <span class="st">"Label assortativity results"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-61044cef5569249bf319" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-61044cef5569249bf319">{"x":{"filter":"none","vertical":false,"caption":"<caption>Label assortativity results<\/caption>","data":[["1","4","10","9","6","0","3","5","2","8","7"],[5.3920704845815,3.59440559440559,2.70588235294118,2.52631578947368,2.54368932038835,2.62931034482759,2.30344827586207,1.64705882352941,1.78947368421053,1.37142857142857,1.07142857142857],[1.4370184184396,1.25408789718361,1.06818691970207,1.06816298780584,1.19535644721595,1.50639339775623,1.33622246282847,1.21290535478655,1.41648924392202,1.08460002399396,1.12055170893244],[0.0796132177596047,0.0916398017288067,0.211879673175871,0.1355446436556,0.104627601431257,0.0762513136536729,0.0764265620955178,0.10060048543989,0.0821905598484388,0.150065182557839,0.123576944908058],[5.84783665532329,5.84783665532329,5.84783665532329,5.84783665532329,5.84783665532329,5.84783665532329,5.84783665532329,5.84783665532329,5.84783665532329,5.84783665532329,5.84783665532329],[0.896670833785299,0.509457051406037,0.342639214968804,0.305073714880874,0.289809480720158,0.258650610050962,0.214385754580391,0.0936698821604084,0.0841695325735155,0.0602171526705277,-0.0103914060736655]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>label<\/th>\n      <th>avg_k<\/th>\n      <th>min_avg_k_mean<\/th>\n      <th>min_avg_k_sd<\/th>\n      <th>k_max<\/th>\n      <th>avg_k_scaled<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p><br></p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">res_lat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">label</span>, <span class="va">avg_k_scaled</span><span class="op">)</span>, y<span class="op">=</span><span class="va">avg_k_scaled</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color<span class="op">=</span><span class="st">"black"</span>, size<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Label"</span>, y<span class="op">=</span><span class="st">"Scaled average degree"</span>, title<span class="op">=</span><span class="st">"Label assortativity score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>        legend.position <span class="op">=</span> <span class="st">"none"</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span></code></pre>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p><br></p>
<p>Not surprisingly, we see cluster 1 being clearly in the top as the
most connected cluster. In the bottom we find cluster 7, which even has
a slightly negative score (though it falls within the standard deviation
of the randomized network, look below for more details).</p>
<p>We can take a closer look at cluster 1 and how it compares against
its randomly dispersed counterpart to further prove the point. Here we
can clearly see why this cluster’s network has a higher average degree
than that of the random network.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"1"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"1"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Cluster 1"</span>,</span>
<span>       caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Observed avg k: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">res_lat</span>, <span class="va">label</span><span class="op">==</span><span class="st">"1"</span><span class="op">)</span><span class="op">[</span>,<span class="st">"avg_k"</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>       <span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">random_clusters</span> <span class="op">==</span> <span class="st">"1"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"1"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Cluster 1 randomly dispersed"</span>,</span>
<span>       caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Random mean avg k: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">res_lat</span>, <span class="va">label</span><span class="op">==</span><span class="st">"1"</span><span class="op">)</span><span class="op">[</span>,<span class="st">"min_avg_k_mean"</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>       <span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span>, plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>, plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p><br></p>
<p>Cluster 7 on the other hand had a score corresponding to a completely
random spatial pattern. Looking at the spatial distribution of the spots
belonging to that label we can understand why that is the case, but we
can also see that this method does not describe everything about the
spatial patterns as we see a trend of cluster 7 spots being localized to
the outer rim of the section.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"7"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"7"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Cluster 7"</span>,</span>
<span>       caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Observed avg k: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">res_lat</span>, <span class="va">label</span><span class="op">==</span><span class="st">"7"</span><span class="op">)</span><span class="op">[</span>,<span class="st">"avg_k"</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>       <span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">random_clusters</span> <span class="op">==</span> <span class="st">"7"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"7"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Cluster 7 randomly dispersed"</span>,</span>
<span>       caption <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Random mean avg k: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">res_lat</span>, <span class="va">label</span><span class="op">==</span><span class="st">"7"</span><span class="op">)</span><span class="op">[</span>,<span class="st">"min_avg_k_mean"</span><span class="op">]</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>       <span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span>, plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>, plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="explore-parameter-settings-n_permutations">Explore parameter settings: <code>n_permutations</code><a class="anchor" aria-label="anchor" href="#explore-parameter-settings-n_permutations"></a>
</h3>
<p>By default, the number of permutations, <code>n_permutations</code>,
used is set to 100, however, it is recommended to try increasing this
value as it may give more robust results.</p>
<p>In many cases though, the number of permutation will have little
effect on the outcome of this analysis. For our current data set we can
study the effect of this by running a few tests and looking at how the
average degree differs if using a higher number of permutations</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">perm_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fl">200</span>, to<span class="op">=</span><span class="fl">1000</span>, by<span class="op">=</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lat_perm_test_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">perm_test</span>, <span class="kw">function</span><span class="op">(</span><span class="va">n_perm</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">f_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/label-assortativity.html">RunLabelAssortativityTest</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">se</span>, </span>
<span>                                                            column_name <span class="op">=</span> <span class="st">"seurat_clusters"</span>, </span>
<span>                                                            n_permutations <span class="op">=</span> <span class="va">n_perm</span>, </span>
<span>                                                            verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">result</span><span class="op">$</span><span class="va">time_s</span> <span class="op">&lt;-</span> <span class="va">f_time</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="va">result</span><span class="op">$</span><span class="va">n_perm</span> <span class="op">&lt;-</span> <span class="va">n_perm</span></span>
<span>  <span class="va">result</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">lat_perm_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">bind_rows</span>, <span class="va">lat_perm_test_list</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">lat_perm_test</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">n_perm</span>, y <span class="op">=</span> <span class="va">min_avg_k_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">min_avg_k_mean</span> <span class="op">-</span> <span class="va">min_avg_k_sd</span>, ymax <span class="op">=</span> <span class="va">min_avg_k_mean</span> <span class="op">+</span> <span class="va">min_avg_k_sd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">lat_perm_test</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">n_perm</span>, y <span class="op">=</span> <span class="va">avg_k</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"orange"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">label</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Effect of n_permutations on average degree in randomized network"</span>, </span>
<span>       caption <span class="op">=</span> <span class="st">"Black dots and error bars: average degree mean and s.d from permutations. Orange line: actual observed average degree."</span>,</span>
<span>       y<span class="op">=</span><span class="st">"Average degree"</span>, x<span class="op">=</span><span class="st">"n permutations"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">lat_perm_test</span><span class="op">$</span><span class="va">min_avg_k_sd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.1104268</span></span></code></pre>
<p><br> Looking at these plots we can see that the number of
permutations actually have very little effect on the outcome and a
standard deviation of around 0.1 for the permuted values is not uncommon
even when using a high number of iterations. In this case and with this
particular data set, you could be confident of the results even at a
<code>n_permutations</code> set to 100. We can also see in this plot
that the observed avg k value for cluster 7 falls within the standard
deviation of the avg k of the permutations, and in that sense we can say
that the spatial pattern of cluster 7 spots is equal to that of a
randomized distribution.</p>
<p>In the previous test we also stored information about the function
run time given different numbers of permutations. By not running
excessive permutations we can save some time, however it is a matter of
seconds.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t_plot</span> <span class="op">&lt;-</span> <span class="va">lat_perm_test</span></span>
<span><span class="va">t_plot</span> <span class="op">&lt;-</span> <span class="va">t_plot</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">n_perm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>.groups <span class="op">=</span> <span class="st">"keep"</span>, time_s<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time_s</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">t_plot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">n_perm</span>, y <span class="op">=</span> <span class="va">time_s</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Function run time with increasing n permutations"</span>,</span>
<span>       y<span class="op">=</span><span class="st">"time (s)"</span>, x<span class="op">=</span><span class="st">"n permutations"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p><br></p>
</div>
</div>
<div class="section level2">
<h2 id="net">Neighborhood Enrichment Analysis<a class="anchor" aria-label="anchor" href="#net"></a>
</h2>
<p>The purpose of a <i>neighborhood enrichment analysis</i> is to test
whether the spots belonging to two different categories are localized
next to each other spatially. To estimate the enrichment of their
co-localization we need to compare it against random permutations of the
labels, forming the null hypothesis saying that the spots of the two
labels are distributed randomly and shares no connections other than
that seen by chance. A <i>z-score</i> for each label pair is calculated
as:</p>
<p><span class="math inline">\(Z_{AB} = \frac{x_{AB} -
µ_{AB}}{σ_{AB}}\)</span></p>
<p>where <span class="math inline">\(x_{AB}\)</span> is the number of
edges observed between spots of labels A and B, <span class="math inline">\(µ_{AB}\)</span> is the permutation mean of the
edges between A and B, and <span class="math inline">\(σ_{AB}\)</span>
is the permutation standard deviation of the edges between A and B.</p>
<p>Thus, a z-score of around 0 can be interpreted as a spatial label
co-localization equal to that seen by chance given the number of spots
within those categories, while a positive z-score indicates an
over-representation of the label pair proximity and a negative z-score
can be viewed as a depletion, or repellant effect, of the label pair
spatially.</p>
<div class="section level3">
<h3 id="kidney-data-neighborhood-enrichment">Kidney data neighborhood enrichment<a class="anchor" aria-label="anchor" href="#kidney-data-neighborhood-enrichment"></a>
</h3>
<p>The neighborhood enrichment analysis is run by calling the function
<code><a href="../reference/neighborhood-enrichment.html">RunNeighborhoodEnrichmentTest()</a></code> and storing the results in
a new results object.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_net</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/neighborhood-enrichment.html">RunNeighborhoodEnrichmentTest</a></span><span class="op">(</span><span class="va">se</span>, column_name <span class="op">=</span> <span class="st">"seurat_clusters"</span>, n_permutations <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Running Neighborhood Enrichment Analysis</span> ──</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Generating neighborhood adjacency data from observed labels in column 'seurat_clusters'</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Observed label adjacency calculations complete</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Generating neighborhood adjacency data from randomized labels</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Randomized label adjacency calculations complete from 1000 iterations</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Scores calculated for each label pair and returned as output tibble</span></span></code></pre>
<p><br></p>
<p>As output, we obtain a tibble with z-scores for each label pair.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span></span>
<span>  <span class="va">res_net</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">z_score</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  rownames <span class="op">=</span> <span class="cn">F</span>, </span>
<span>  caption <span class="op">=</span> <span class="st">"Neighborhood enrichment analysis output"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-5b6f298a731cd88d2a9f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5b6f298a731cd88d2a9f">{"x":{"filter":"none","vertical":false,"caption":"<caption>Neighborhood enrichment analysis output<\/caption>","data":[["Label_4","Label_8","Label_0","Label_1","Label_1","Label_2","Label_0","Label_4","Label_1","Label_3","Label_2","Label_4","Label_1","Label_5","Label_3","Label_4","Label_1","Label_6","Label_4","Label_6","Label_1","Label_7","Label_4","Label_5","Label_3","Label_7","Label_2","Label_3","Label_1","Label_4","Label_3","Label_6","Label_0","Label_8","Label_1","Label_9","Label_2","Label_7","Label_2","Label_5","Label_1","Label_10","Label_2","Label_8","Label_0","Label_5","Label_3","Label_8","Label_4","Label_7","Label_5","Label_6","Label_1","Label_8","Label_4","Label_10","Label_0","Label_10","Label_5","Label_8","Label_3","Label_5","Label_2","Label_10","Label_6","Label_10","Label_5","Label_10","Label_7","Label_8","Label_4","Label_9","Label_7","Label_10","Label_3","Label_10","Label_8","Label_10","Label_2","Label_6","Label_3","Label_9","Label_5","Label_9","Label_0","Label_7","Label_5","Label_7","Label_8","Label_9","Label_7","Label_9","Label_0","Label_6","Label_6","Label_8","Label_9","Label_10","Label_0","Label_3","Label_2","Label_9","Label_0","Label_2","Label_6","Label_7","Label_0","Label_9","Label_6","Label_9"],["Label_8","Label_4","Label_1","Label_0","Label_2","Label_1","Label_4","Label_0","Label_3","Label_1","Label_4","Label_2","Label_5","Label_1","Label_4","Label_3","Label_6","Label_1","Label_6","Label_4","Label_7","Label_1","Label_5","Label_4","Label_7","Label_3","Label_3","Label_2","Label_4","Label_1","Label_6","Label_3","Label_8","Label_0","Label_9","Label_1","Label_7","Label_2","Label_5","Label_2","Label_10","Label_1","Label_8","Label_2","Label_5","Label_0","Label_8","Label_3","Label_7","Label_4","Label_6","Label_5","Label_8","Label_1","Label_10","Label_4","Label_10","Label_0","Label_8","Label_5","Label_5","Label_3","Label_10","Label_2","Label_10","Label_6","Label_10","Label_5","Label_8","Label_7","Label_9","Label_4","Label_10","Label_7","Label_10","Label_3","Label_10","Label_8","Label_6","Label_2","Label_9","Label_3","Label_9","Label_5","Label_7","Label_0","Label_7","Label_5","Label_9","Label_8","Label_9","Label_7","Label_6","Label_0","Label_8","Label_6","Label_10","Label_9","Label_3","Label_0","Label_9","Label_2","Label_2","Label_0","Label_7","Label_6","Label_9","Label_0","Label_9","Label_6"],["Label_4-Label_8","Label_8-Label_4","Label_0-Label_1","Label_1-Label_0","Label_1-Label_2","Label_2-Label_1","Label_0-Label_4","Label_4-Label_0","Label_1-Label_3","Label_3-Label_1","Label_2-Label_4","Label_4-Label_2","Label_1-Label_5","Label_5-Label_1","Label_3-Label_4","Label_4-Label_3","Label_1-Label_6","Label_6-Label_1","Label_4-Label_6","Label_6-Label_4","Label_1-Label_7","Label_7-Label_1","Label_4-Label_5","Label_5-Label_4","Label_3-Label_7","Label_7-Label_3","Label_2-Label_3","Label_3-Label_2","Label_1-Label_4","Label_4-Label_1","Label_3-Label_6","Label_6-Label_3","Label_0-Label_8","Label_8-Label_0","Label_1-Label_9","Label_9-Label_1","Label_2-Label_7","Label_7-Label_2","Label_2-Label_5","Label_5-Label_2","Label_1-Label_10","Label_10-Label_1","Label_2-Label_8","Label_8-Label_2","Label_0-Label_5","Label_5-Label_0","Label_3-Label_8","Label_8-Label_3","Label_4-Label_7","Label_7-Label_4","Label_5-Label_6","Label_6-Label_5","Label_1-Label_8","Label_8-Label_1","Label_4-Label_10","Label_10-Label_4","Label_0-Label_10","Label_10-Label_0","Label_5-Label_8","Label_8-Label_5","Label_3-Label_5","Label_5-Label_3","Label_2-Label_10","Label_10-Label_2","Label_6-Label_10","Label_10-Label_6","Label_5-Label_10","Label_10-Label_5","Label_7-Label_8","Label_8-Label_7","Label_4-Label_9","Label_9-Label_4","Label_7-Label_10","Label_10-Label_7","Label_3-Label_10","Label_10-Label_3","Label_8-Label_10","Label_10-Label_8","Label_2-Label_6","Label_6-Label_2","Label_3-Label_9","Label_9-Label_3","Label_5-Label_9","Label_9-Label_5","Label_0-Label_7","Label_7-Label_0","Label_5-Label_7","Label_7-Label_5","Label_8-Label_9","Label_9-Label_8","Label_7-Label_9","Label_9-Label_7","Label_0-Label_6","Label_6-Label_0","Label_6-Label_8","Label_8-Label_6","Label_9-Label_10","Label_10-Label_9","Label_0-Label_3","Label_3-Label_0","Label_2-Label_9","Label_9-Label_2","Label_0-Label_2","Label_2-Label_0","Label_6-Label_7","Label_7-Label_6","Label_0-Label_9","Label_9-Label_0","Label_6-Label_9","Label_9-Label_6"],[137,137,0,0,0,0,0,0,1,1,5,5,0,0,2,2,3,3,136,136,0,0,3,3,106,106,241,241,53,53,14,14,0,0,0,0,108,108,159,159,0,0,2,2,177,177,0,0,4,4,10,10,78,78,0,0,12,12,1,1,117,117,11,11,0,0,2,2,0,0,8,8,0,0,12,12,0,0,68,68,18,18,10,10,87,87,43,43,3,3,19,19,92,92,13,13,3,3,191,191,32,32,227,227,27,27,46,46,19,19],[26.953,26.953,227.872,227.872,192.663,192.663,144.579,144.579,159.884,159.884,122.049,122.049,104.386,104.386,101.369,101.369,97.12,97.12,62.007,62.007,64.124,64.124,65.563,65.563,50.096,50.096,149.891,149.891,130.336,130.336,76.466,76.466,47.253,47.253,40.652,40.652,60.016,60.016,97.063,97.063,35.517,35.517,39.869,39.869,116.004,116.004,33.258,33.258,40.639,40.639,49.491,49.491,42.723,42.723,22.113,22.113,39.006,39.006,21.419,21.419,80.877,80.877,33.342,33.342,16.805,16.805,17.937,17.937,13.429,13.429,25.675,25.675,11.009,11.009,27.471,27.471,7.337,7.337,91.765,91.765,31.624,31.624,20.497,20.497,70.649,70.649,32.375,32.375,8.461,8.461,12.927,12.927,108.381,108.381,20.038,20.038,6.981,6.981,177.942,177.942,37.994,37.994,213.579,213.579,30.733,30.733,45.447,45.447,19.127,19.127],[4.89762981224365,4.89762981224365,12.7116167815586,12.7116167815586,12.6732806740419,12.6732806740419,10.1553379997856,10.1553379997856,11.5527490239341,11.5527490239341,9.51268048922543,9.51268048922543,9.06461092221675,9.06461092221675,8.94409502609603,8.94409502609603,9.09683199539006,9.09683199539006,7.41916403612934,7.41916403612934,7.36647058562572,7.36647058562572,7.50028568024481,7.50028568024481,6.85038040635056,6.85038040635056,11.4381795295821,11.4381795295821,9.98392622082028,9.98392622082028,8.18326400709459,8.18326400709459,6.23922422412586,6.23922422412586,5.78483883616133,5.78483883616133,6.9967634445291,6.9967634445291,9.17754097012148,9.17754097012148,5.36418544473301,5.36418544473301,5.94383446675361,5.94383446675361,9.67106578994857,9.67106578994857,5.33684531515744,5.33684531515744,6.00755938545511,6.00755938545511,6.67881168513722,6.67881168513722,5.97879728850352,5.97879728850352,4.37622924243948,4.37622924243948,5.67363676614516,5.67363676614516,4.57300244383833,4.57300244383833,8.14519583651708,8.14519583651708,5.15068593155956,5.15068593155956,3.99436226823881,3.99436226823881,4.07500142780793,4.07500142780793,3.51415826455046,3.51415826455046,4.78186587445123,4.78186587445123,3.20424502592829,3.20424502592829,4.97874953647469,4.97874953647469,2.61730420113545,2.61730420113545,8.8838447587572,8.8838447587572,5.2771651928353,5.2771651928353,4.29935756543643,4.29935756543643,7.75718847089414,7.75718847089414,5.257377199233,5.257377199233,2.75537131274009,2.75537131274009,3.44347622737961,3.44347622737961,9.48165284856711,9.48165284856711,4.25401606163548,4.25401606163548,2.63240737131785,2.63240737131785,11.4947276942416,11.4947276942416,5.52109105580106,5.52109105580106,13.2600749842747,13.2600749842747,5.16356208187462,5.16356208187462,5.96110104978315,5.96110104978315,4.2702583184283,4.2702583184283],[22.469,22.469,-17.926,-17.926,-15.202,-15.202,-14.237,-14.237,-13.753,-13.753,-12.305,-12.305,-11.516,-11.516,-11.11,-11.11,-10.346,-10.346,9.973,9.973,-8.705,-8.705,-8.341,-8.341,8.161,8.161,7.965,7.965,-7.746,-7.746,-7.633,-7.633,-7.574,-7.574,-7.027,-7.027,6.858,6.858,6.749,6.749,-6.621,-6.621,-6.371,-6.371,6.307,6.307,-6.232,-6.232,-6.099,-6.099,-5.913,-5.913,5.9,5.9,-5.053,-5.053,-4.76,-4.76,-4.465,-4.465,4.435,4.435,-4.338,-4.338,-4.207,-4.207,-3.911,-3.911,-3.821,-3.821,-3.696,-3.696,-3.436,-3.436,-3.107,-3.107,-2.803,-2.803,-2.675,-2.675,-2.582,-2.582,-2.442,-2.442,2.108,2.108,2.021,2.021,-1.982,-1.982,1.764,1.764,-1.728,-1.728,-1.654,-1.654,-1.512,-1.512,1.136,1.136,-1.086,-1.086,1.012,1.012,-0.723,-0.723,0.093,0.093,-0.03,-0.03]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>label_1<\/th>\n      <th>label_2<\/th>\n      <th>label_label<\/th>\n      <th>edges<\/th>\n      <th>perm_mean<\/th>\n      <th>perm_sd<\/th>\n      <th>z_score<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,5,6]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><p><br></p>
<p>The results can also be plotted in a few different ways, where the
most straightforward is to look at it as a heatmap.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Label_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">se</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hm_plot_data</span> <span class="op">&lt;-</span> <span class="va">res_net</span></span>
<span></span>
<span><span class="va">hm_plot_data</span><span class="op">$</span><span class="va">label_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">hm_plot_data</span><span class="op">$</span><span class="va">label_1</span>, levels <span class="op">=</span> <span class="va">cluster_labels</span><span class="op">)</span></span>
<span><span class="va">hm_plot_data</span><span class="op">$</span><span class="va">label_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">hm_plot_data</span><span class="op">$</span><span class="va">label_2</span>, levels <span class="op">=</span> <span class="va">cluster_labels</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">hm_plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">label_1</span>, <span class="va">label_2</span>, fill<span class="op">=</span> <span class="va">z_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>            lwd <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>            linetype <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"#0474BA"</span>,</span>
<span>                       mid <span class="op">=</span> <span class="st">"grey90"</span>,</span>
<span>                       high <span class="op">=</span> <span class="st">"#F17720"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">""</span>, title<span class="op">=</span><span class="st">"Neighborhood enrichment"</span>, fill<span class="op">=</span><span class="st">"Z-score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, </span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<p><br></p>
<p>We can also plot the top most enriched pairs as a bar chart. Since
the output table contains each label pair in duplicate, we first need to
remove the excessive duplicated values.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">top_n_plot</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">res_net</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html" class="external-link">where</a></span><span class="op">(</span><span class="va">is.factor</span><span class="op">)</span>, <span class="va">as.character</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span>grp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">label_1</span>, <span class="va">label_2</span><span class="op">)</span>, <span class="st">"-"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="va">label_1</span>, <span class="va">label_2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>  <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">grp</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">plot_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">z_score</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">top_n_plot</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">z_score</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  <span class="va">plot_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">z_score</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">top_n_plot</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">z_score</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data</span><span class="op">$</span><span class="va">direction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">plot_data</span><span class="op">$</span><span class="va">z_score</span><span class="op">&gt;</span><span class="fl">0</span>, <span class="st">"over-represented"</span>, <span class="st">"under-represented"</span><span class="op">)</span></span>
<span><span class="va">colors_direction_fill</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#F17720"</span>, <span class="st">"#0474BA"</span><span class="op">)</span>, nm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"over-represented"</span>, <span class="st">"under-represented"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html" class="external-link">reorder</a></span><span class="op">(</span><span class="va">label_label</span>, <span class="va">z_score</span><span class="op">)</span>, y<span class="op">=</span><span class="va">z_score</span>, fill <span class="op">=</span> <span class="va">direction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Z-score"</span>, title<span class="op">=</span><span class="st">"Top enriched label pairs"</span>, fill<span class="op">=</span><span class="st">"Enrichment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">colors_direction_fill</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, color<span class="op">=</span><span class="st">"black"</span>, size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html" class="external-link">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>        panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>        legend.position <span class="op">=</span> <span class="st">"top"</span>, </span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, </span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p><br></p>
<p>From the results we can see that spots of clusters 4 and 8 appear a
lot more often next to each other than you would expect by chance, while
spots of clusters 0 and 1 have a strong negative z-score and thus
separated from each other spatially.</p>
<p>We can also plot these cluster pairs spatially to have a look if
these results make sense. First, let’s look at the top two most
over-represented label pairs.</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"4"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"4"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"8"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"8"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Clusters 4 and 8"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"3"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"3"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"7"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"7"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Clusters 3 and 7"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span>, plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p><br></p>
<p>We can see that in the case of clusters 4 and 8, all spots except one
appear next to another spot of the other label, which clearly
demonstrates that these two clusters really are co-localizing spatially
in our tissue. Clusters 3 and 7 are also appearing very often next to
one another, which makes sense given the high z-score.</p>
<p>Now, let’s look at the bottom two enriched label pairs instead.</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"0"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"0"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"1"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"1"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Clusters 0 and 1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"1"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"1"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op">==</span> <span class="st">"2"</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="st">"2"</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Clusters 1 and 2"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">|</span> <span class="va">p2</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span>, plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<p><br> Seeing these two label pair examples, it is clear why they have
such negative z-scores since there is not a single instance where spots
of the different labels appear adjacent to one another.</p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="explore-parameter-settings-n_permutations-1">Explore parameter settings: <code>n_permutations</code><a class="anchor" aria-label="anchor" href="#explore-parameter-settings-n_permutations-1"></a>
</h3>
<p>With the <code><a href="../reference/neighborhood-enrichment.html">RunNeighborhoodEnrichmentTest()</a></code> function you
have option to adjust the number of permutations used for the label
randomization. Picking a high enough value for this is crucial to the
analysis, since the standard deviation is taken into account in the
z-score calculations and will therefore influence the results. It could
be valuable to test a few different options for this and have a look at
when the results starts to stabilize and can therefore be regarded as
more robust</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">perm_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>from<span class="op">=</span><span class="fl">200</span>, to<span class="op">=</span><span class="fl">1000</span>, by<span class="op">=</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nea_perm_test_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">perm_test</span>, <span class="kw">function</span><span class="op">(</span><span class="va">n_perm</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">f_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/neighborhood-enrichment.html">RunNeighborhoodEnrichmentTest</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">se</span>, </span>
<span>                                                                column_name <span class="op">=</span> <span class="st">"seurat_clusters"</span>, </span>
<span>                                                                n_permutations <span class="op">=</span> <span class="va">n_perm</span>, </span>
<span>                                                                verbose <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">result</span><span class="op">$</span><span class="va">time_s</span> <span class="op">&lt;-</span> <span class="va">f_time</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="va">result</span><span class="op">$</span><span class="va">n_perm</span> <span class="op">&lt;-</span> <span class="va">n_perm</span></span>
<span>  <span class="va">result</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">nea_perm_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">bind_rows</span>, <span class="va">nea_perm_test_list</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">nea_perm_test</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">n_perm</span>, y <span class="op">=</span> <span class="va">z_score</span>, color<span class="op">=</span><span class="va">label_label</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">perm_test</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Effect of n_permutations on z-score"</span>, </span>
<span>       caption <span class="op">=</span> <span class="st">"Each line corresponds to the z-score of a label pair"</span>,</span>
<span>       y<span class="op">=</span><span class="st">"Z-score"</span>, x<span class="op">=</span><span class="st">"n permutations"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-32-1.png" width="700"></p>
<p><br> Here we can see that the scores are changing quite a lot with
lower numbers of permutations and start to stabilize at around
<code>n_permutations = 200</code> and above. If you are unsure of how
many permutations are needed, it could be useful to run a test like this
to see how variable your data set is and if it requires you to pick a
higher number.</p>
<p>We can also here look at the run times of the function given
increasing numbers of permutations used. This analysis runs relatively
quick, so there is not much time loss for running the analysis with a
large number of permutations.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t_plot</span> <span class="op">&lt;-</span> <span class="va">nea_perm_test</span></span>
<span><span class="va">t_plot</span> <span class="op">&lt;-</span> <span class="va">t_plot</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">n_perm</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>.groups <span class="op">=</span> <span class="st">"keep"</span>, time_s<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time_s</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">t_plot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">n_perm</span>, y <span class="op">=</span> <span class="va">time_s</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">perm_test</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Function run time with increasing n permutations"</span>,</span>
<span>       y<span class="op">=</span><span class="st">"time (s)"</span>, x<span class="op">=</span><span class="st">"n permutations"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<p><br></p>
</div>
<div class="section level3">
<h3 id="explore-parameter-settings-column_labels">Explore parameter settings: <code>column_labels</code><a class="anchor" aria-label="anchor" href="#explore-parameter-settings-column_labels"></a>
</h3>
<p>If you for some reason would like to only include some of the
clusters in your data set you can specify this using the
<code>column_labels</code> argument in
<code><a href="../reference/neighborhood-enrichment.html">RunNeighborhoodEnrichmentTest()</a></code>. This will subset your data
to contain only the specified labels prior to running the analysis, and
therefore your results will end up being different as compared to
running the analysis with all labels.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_selection</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"4"</span>, <span class="st">"6"</span>, <span class="st">"8"</span><span class="op">)</span></span>
<span><span class="va">res_net_medulla</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/neighborhood-enrichment.html">RunNeighborhoodEnrichmentTest</a></span><span class="op">(</span><span class="va">se</span>, </span>
<span>                                                 column_name <span class="op">=</span> <span class="st">"seurat_clusters"</span>, </span>
<span>                                                 column_labels <span class="op">=</span> <span class="va">cluster_selection</span>, </span>
<span>                                                 n_permutations <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## ── <span style="font-weight: bold;">Running Neighborhood Enrichment Analysis</span> ──</span></span></code></pre>
<pre><code><span><span class="co">## </span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Generating neighborhood adjacency data from observed labels in column 'seurat_clusters'</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Analysis limited to study 4 unique labels</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Observed label adjacency calculations complete</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Generating neighborhood adjacency data from randomized labels</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Randomized label adjacency calculations complete from 1000 iterations</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #00BB00;">✔</span> Scores calculated for each label pair and returned as output tibble</span></span></code></pre>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span></span>
<span>  <span class="va">res_net_medulla</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">z_score</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  rownames <span class="op">=</span> <span class="cn">F</span>, </span>
<span>  caption <span class="op">=</span> <span class="st">"Neighborhood enrichment analysis output for label subset"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div id="htmlwidget-7bd6fd26da292abebd83" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-7bd6fd26da292abebd83">{"x":{"filter":"none","vertical":false,"caption":"<caption>Neighborhood enrichment analysis output for label subset<\/caption>","data":[["Label_1","Label_6","Label_1","Label_4","Label_4","Label_8","Label_6","Label_8","Label_1","Label_8","Label_4","Label_6"],["Label_6","Label_1","Label_4","Label_1","Label_8","Label_4","Label_8","Label_6","Label_8","Label_1","Label_6","Label_4"],["Label_1-Label_6","Label_6-Label_1","Label_1-Label_4","Label_4-Label_1","Label_4-Label_8","Label_8-Label_4","Label_6-Label_8","Label_8-Label_6","Label_1-Label_8","Label_8-Label_1","Label_4-Label_6","Label_6-Label_4"],[3,3,53,53,137,137,13,13,78,78,136,136],[256.577,256.577,342.041,342.041,71.006,71.006,52.987,52.987,111.479,111.479,162.536,162.536],[11.9725274028675,11.9725274028675,13.8156502268692,13.8156502268692,7.24088353686167,7.24088353686167,6.47740594588511,6.47740594588511,8.40393867095573,8.40393867095573,10.5695988769877,10.5695988769877],[-21.18,-21.18,-20.921,-20.921,9.114,9.114,-6.173,-6.173,-3.984,-3.984,-2.511,-2.511]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>label_1<\/th>\n      <th>label_2<\/th>\n      <th>label_label<\/th>\n      <th>edges<\/th>\n      <th>perm_mean<\/th>\n      <th>perm_sd<\/th>\n      <th>z_score<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,5,6]}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Label_"</span>, <span class="va">cluster_selection</span><span class="op">)</span></span>
<span><span class="va">hm_plot_data</span> <span class="op">&lt;-</span> <span class="va">res_net_medulla</span></span>
<span></span>
<span><span class="va">hm_plot_data</span><span class="op">$</span><span class="va">label_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">hm_plot_data</span><span class="op">$</span><span class="va">label_1</span>, levels <span class="op">=</span> <span class="va">cluster_labels</span><span class="op">)</span></span>
<span><span class="va">hm_plot_data</span><span class="op">$</span><span class="va">label_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">hm_plot_data</span><span class="op">$</span><span class="va">label_2</span>, levels <span class="op">=</span> <span class="va">cluster_labels</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">hm_plot_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">label_1</span>, <span class="va">label_2</span>, fill<span class="op">=</span> <span class="va">z_score</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>            lwd <span class="op">=</span> <span class="fl">1.5</span>,</span>
<span>            linetype <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"#0474BA"</span>,</span>
<span>                       mid <span class="op">=</span> <span class="st">"grey90"</span>,</span>
<span>                       high <span class="op">=</span> <span class="st">"#F17720"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">""</span>, title<span class="op">=</span><span class="st">"Neighborhood enrichment"</span>, fill<span class="op">=</span><span class="st">"Z-score"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>        plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>        axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>        legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, </span>
<span>        legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-36-1.png" width="700"></p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">spatial_network</span>, <span class="va">cluster</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cluster_selection</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, xend <span class="op">=</span> <span class="va">x_end</span>, y <span class="op">=</span> <span class="va">y_start</span>, yend <span class="op">=</span> <span class="va">y_end</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>color<span class="op">=</span><span class="st">"grey90"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_start</span>, y <span class="op">=</span> <span class="va">y_start</span>, color <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cluster_colors</span><span class="op">[</span><span class="va">cluster_selection</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Medulla associated clusters"</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>aspect.ratio <span class="op">=</span> <span class="fl">1</span>, plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_statistics_for_labelled_spots_files/figure-html/unnamed-chunk-37-1.png" width="700"></p>
<p><br></p>
<p>Now we can see that clusters 1 and 8 no longer have a positive
enrichment, even if their spatial relationship is the same as when using
the full data set. This is likely due to the large size of cluster 1 and
that a large proportion of the total number of spots belong to this
label, giving it a high likelihood of appearing next to spots of other
labels when we randomly shuffle the labels.</p>
<p>This highlights the importance of being familiar with your data set
and to be cautions of the different parameters that might influence an
analysis like this, such as section size and number of spots within each
label.</p>
<p><br></p>
<hr>
<details open><summary><strong>Package version</strong>
</summary><ul>
<li>
<code>semla</code>: 1.0.0</li>
</ul></details><p><br></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/ludvigla" class="external-link">Ludvig Larsson</a>, <a href="https://github.com/lfranzen" class="external-link">Lovisa Franzen</a>, <a href="https://www.spatialresearch.org/" class="external-link"><img src="reference/figures/sr-logo.png" height="36" alt="spatialresearch"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
