<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="semla">
<title>Images and spot coordinates • semla</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Images and spot coordinates">
<meta property="og:description" content="semla">
<meta property="og:image" content="https://ludvigla.github.io/semla/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">semla</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/semla.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-tutorials">Tutorials</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-tutorials">
    <h6 class="dropdown-header" data-toc-skip>Intro</h6>
    <a class="dropdown-item" href="../articles/getting_started.html">Get started</a>
    <a class="dropdown-item" href="../articles/subset_and_merge.html">Subset/merge</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial visualization</h6>
    <a class="dropdown-item" href="../articles/numeric_features.html">Map numeric features</a>
    <a class="dropdown-item" href="../articles/categorical_features.html">Map categorical features</a>
    <a class="dropdown-item" href="../articles/advanced_visualization.html">Advanced visualization</a>
    <a class="dropdown-item" href="../articles/feature_viewer.html">Feature viewer</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Spatial methods</h6>
    <a class="dropdown-item" href="../articles/radial_distances.html">Radial distances</a>
    <a class="dropdown-item" href="../articles/region_neighbors.html">Region neighbors</a>
    <a class="dropdown-item" href="../articles/spatial_statistics_for_labelled_spots.html">Statistics for labelled spots</a>
    <a class="dropdown-item" href="../articles/spatial_autocorrelation.html">Spatial autocorrelation</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Analysis</h6>
    <a class="dropdown-item" href="../articles/cell_type_mapping_with_NNLS.html">Cell type mapping</a>
    <a class="dropdown-item" href="../articles/digital_unrolling.html">Digital unrolling</a>
    <a class="dropdown-item" href="../articles/NNMF.html">Non-negative Matrix Factorization</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Image processing</h6>
    <a class="dropdown-item" href="../articles/images_and_coordinates.html">Images and spot coordinates</a>
    <a class="dropdown-item" href="../articles/mask_images.html">Image masking</a>
    <a class="dropdown-item" href="../articles/image_alignment.html">Image alignment</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/compare_cell_type_mapping_NNLS.html">cell type mapping comparison</a>
    <a class="dropdown-item" href="../articles/create_object.html">Create a Staffli object</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ludvigla/semla" aria-label="GitHub">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Images and spot coordinates</h1>
            
            <h4 data-toc-skip class="date">Last compiled: 11 April
2023</h4>
      
      
      <div class="d-none name"><code>images_and_coordinates.rmd</code></div>
    </div>

    
    
<p>Load required libraries:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ludvigla.github.io/semla/">semla</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/magick/" class="external-link">magick</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://arxiv.org/abs/1403.2805" class="external-link">jsonlite</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="image-transformation">Image transformation<a class="anchor" aria-label="anchor" href="#image-transformation"></a>
</h2>
<p><code>semla</code> uses the <code>magick</code> R package to read and
process images. Please have a look at <a href="https://cran.r-project.org/web/packages/magick/vignettes/intro.html" class="external-link">this</a>
vignette if you want to know more about <code>magick</code>.</p>
<p>Let’s load an H&amp;E image and visualize it:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">he</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"https://data.mendeley.com/public-files/datasets/kj3ntnt6vb/files"</span>,</span>
<span>                <span class="st">"d97fb9ce-eb7d-4c1f-98e0-c17582024a40/file_downloaded"</span><span class="op">)</span></span>
<span><span class="va">im</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html" class="external-link">image_read</a></span><span class="op">(</span><span class="va">he</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get information about image</span></span>
<span><span class="va">info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span></span>
<span><span class="va">info</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">##   format width height colorspace matte filesize density</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> JPEG    <span style="text-decoration: underline;">1</span>882   <span style="text-decoration: underline;">2</span>000 sRGB       FALSE  1<span style="text-decoration: underline;">030</span>876 72x72</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot HE image</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">info</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="va">info</span><span class="op">$</span><span class="va">height</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
<p>The H&amp;E image is 2000 pixels high and 1882 pixels wide. If we
want to scale this image, we can use <code><a href="https://docs.ropensci.org/magick/reference/transform.html" class="external-link">image_scale()</a></code> from the
<code>magick</code> R package:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Scale down and plot HE image</span></span>
<span><span class="va">im_small</span> <span class="op">&lt;-</span> <span class="va">im</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html" class="external-link">image_scale</a></span><span class="op">(</span><span class="st">"400"</span><span class="op">)</span> </span>
<span><span class="va">info_small</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_small</span><span class="op">)</span></span>
<span><span class="va">info_small</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">##   format width height colorspace matte filesize density</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> JPEG     400    425 sRGB       FALSE        0 72x72</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im_small</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">info_small</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="va">info_small</span><span class="op">$</span><span class="va">height</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>We can also apply various types of transformations:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rotate image</span></span>
<span><span class="va">im_rot</span> <span class="op">&lt;-</span> <span class="va">im_small</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html" class="external-link">image_rotate</a></span><span class="op">(</span>degrees <span class="op">=</span> <span class="fl">45</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mirror image along x axis</span></span>
<span><span class="va">im_xrefl</span> <span class="op">&lt;-</span> <span class="va">im_small</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html" class="external-link">image_flop</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Mirror image along y axis</span></span>
<span><span class="va">im_yrefl</span> <span class="op">&lt;-</span> <span class="va">im_small</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html" class="external-link">image_flip</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im_small</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"original "</span>, <span class="va">info_small</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="va">info_small</span><span class="op">$</span><span class="va">height</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im_rot</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rotated 45 degrees ("</span>, </span>
<span>             <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_rot</span><span class="op">)</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_rot</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im_xrefl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"reflected along x axis ("</span>, </span>
<span>             <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_xrefl</span><span class="op">)</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_xrefl</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im_yrefl</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"reflected along y axis ("</span>, </span>
<span>             <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_yrefl</span><span class="op">)</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_yrefl</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<p>When working with multiple SRT data sets, it can be useful to align
the tissue sections to have roughly the same orientation and size. In
other words, we might want to register our H&amp;E images to a reference
image. When doing so, we want to apply rotations, reflections and
translations. The issue with the default <code>magick</code> rotation
function is that it creates a bounding box to hold the entire image,
which makes the image bigger. In the plots above you cans see that the
rotated image is 586x586 pixels in size compared to the 400x425 of the
other images.</p>
<p>The main issue is that if we want to map spots to our H&amp;E images
after rotation, the scale has now changed and the spots will appear
smaller. Instead, it is more convenient to keep the same input
dimensions.</p>
<p><code>semla</code> provide two functions to complement the
transformation functions available in the <code>magick</code> R package:
<code><a href="../reference/ImageTranslate.html">ImageTranslate()</a></code> and <code><a href="../reference/ImageTransform.html">ImageTransform()</a></code>.</p>
<p><code>ImageTranslate</code> can be used to move H&amp;E image. If you
imagine that you have an art board with the same dimensions as your
image, this function can be used to move the H&amp;E image on the art
board. However, only the part of the image that is inside the art board
will be kept.</p>
<p><code>ImageTransform</code> can be used to rotate and translate
H&amp;E images. Again, the transformations occur inside the art board
and only the part of the image still inside the art board will be
returned.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Move image 100 pixels to the right and 100 pixels down</span></span>
<span><span class="va">im_rot</span> <span class="op">&lt;-</span> <span class="va">im_small</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/ImageTranslate.html">ImageTranslate</a></span><span class="op">(</span>xy_offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rotate image 45 degrees</span></span>
<span><span class="va">im_transf</span> <span class="op">&lt;-</span> <span class="va">im_small</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/ImageTransform.html">ImageTransform</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, xy_offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rotate image 45 degrees and move image 100 pixels to the left and 100 pixels up</span></span>
<span><span class="va">im_transf2</span> <span class="op">&lt;-</span> <span class="va">im_small</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/ImageTransform.html">ImageTransform</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">45</span>, xy_offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="op">-</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im_small</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"original ("</span>, <span class="va">info_small</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="va">info_small</span><span class="op">$</span><span class="va">height</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im_rot</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"moved towards bottom right corner ("</span>, </span>
<span>             <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_rot</span><span class="op">)</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_rot</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im_transf</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rotated 45 degrees clockwise ("</span>, </span>
<span>             <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_transf</span><span class="op">)</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_transf</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">im_transf2</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/as.raster.html" class="external-link">as.raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rotated 45 degrees clockwise and moved ("</span>, </span>
<span>             <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_transf2</span><span class="op">)</span><span class="op">$</span><span class="va">width</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im_transf2</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>As you can see, regardless of what transformation we apply, the image
dimensions remain the same.</p>
</div>
<div class="section level2">
<h2 id="spot-transformation">Spot transformation<a class="anchor" aria-label="anchor" href="#spot-transformation"></a>
</h2>
<p>Let’s load some spot coordinates for the H&amp;E image that we
have.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get example coordinate file</span></span>
<span><span class="va">cordinatefile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/mousebrain/spatial"</span>, </span>
<span>                             <span class="st">"tissue_positions_list.csv"</span>, </span>
<span>                             package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load coordinates</span></span>
<span><span class="va">xy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/LoadSpatialCoordinates.html">LoadSpatialCoordinates</a></span><span class="op">(</span>coordinatefiles <span class="op">=</span> <span class="va">cordinatefile</span>, verbose <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">xy</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2,560 × 7</span></span></span>
<span><span class="co">##    barcode            selected     y     x pxl_row_in_fullres pxl_col_…¹ sampl…²</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> CATACAAAGCCGAACC-1        1    13    35               <span style="text-decoration: underline;">4</span>117       <span style="text-decoration: underline;">6</span>086       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> CTGAGCAAGTAACAAG-1        1    15    25               <span style="text-decoration: underline;">4</span>472       <span style="text-decoration: underline;">5</span>062       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> GGGTACCCACGGTCCT-1        1    14    26               <span style="text-decoration: underline;">4</span>294       <span style="text-decoration: underline;">5</span>164       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> ACGGAATTTAGCAAAT-1        1    15    27               <span style="text-decoration: underline;">4</span>472       <span style="text-decoration: underline;">5</span>266       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> GGGCGGTCCTATTGTC-1        1    14    28               <span style="text-decoration: underline;">4</span>294       <span style="text-decoration: underline;">5</span>369       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> ATGTTACGAGCAATAC-1        1    15    29               <span style="text-decoration: underline;">4</span>472       <span style="text-decoration: underline;">5</span>471       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> AACCATGGGATCGCTA-1        1    14    30               <span style="text-decoration: underline;">4</span>294       <span style="text-decoration: underline;">5</span>574       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> TCGCATCCCTAAGTGT-1        1    15    31               <span style="text-decoration: underline;">4</span>473       <span style="text-decoration: underline;">5</span>676       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> ACTTAGTACGACAAGA-1        1    14    32               <span style="text-decoration: underline;">4</span>295       <span style="text-decoration: underline;">5</span>778       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> GAGCTCTCGGACCTAA-1        1    15    33               <span style="text-decoration: underline;">4</span>473       <span style="text-decoration: underline;">5</span>881       1</span></span>
<span><span class="co">## <span style="color: #949494;"># … with 2,550 more rows, and abbreviated variable names ¹​pxl_col_in_fullres,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   ²​sampleID</span></span></span></code></pre>
<p>Here we have access to the Visium grid coordinates and the H&amp;E
image coordinates for the full resolution image used for
<code>spaceranger count</code>. We also have a column with spot barcodes
and a column called <code>selected</code> which holds information about
what sots are located under the tissue.</p>
<p>We can illustrate what this means with a plot:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">xy</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">pxl_col_in_fullres</span>, <span class="va">pxl_row_in_fullres</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>The spots with a value of 1 correspond to spots under the tissue. But
right now, the tissue is upside down in the plot relative to our H&amp;E
image. This is because the origin (0, 0) of the plot is located in the
bottom left corner, but for images its in the upper right corner.</p>
<p>We can fix this easily by inverting the y axis. However, to do this
properly, we need the dimensions of the H&amp;E image…</p>
<p>Unfortunately, we don’t have access to this information right now so
we need to load the scalefactors and an H&amp;E image provided in the
spaceranger output folder.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scalefactorfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/mousebrain/spatial"</span>, </span>
<span>                             <span class="st">"scalefactors_json.json"</span>, </span>
<span>                             package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># read scalefactors</span></span>
<span><span class="va">scalefactors</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/read_json.html" class="external-link">read_json</a></span><span class="op">(</span><span class="va">scalefactorfile</span><span class="op">)</span></span>
<span><span class="va">scalefactors</span></span></code></pre></div>
<pre><code><span><span class="co">## $spot_diameter_fullres</span></span>
<span><span class="co">## [1] 143.3171</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $tissue_hires_scalef</span></span>
<span><span class="co">## [1] 0.1039393</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $fiducial_diameter_fullres</span></span>
<span><span class="co">## [1] 214.9757</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $tissue_lowres_scalef</span></span>
<span><span class="co">## [1] 0.03118179</span></span></code></pre>
<p>Now we can see that the scaling factor between the original H&amp;E
image and the tissue_lowres image is ~0.03. Let’s load the tissue_lowres
and convert our coordinates to fit the image:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lowresimagefile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/mousebrain/spatial"</span>, </span>
<span>                             <span class="st">"tissue_lowres_image.jpg"</span>, </span>
<span>                             package <span class="op">=</span> <span class="st">"semla"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load image</span></span>
<span><span class="va">im</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html" class="external-link">image_read</a></span><span class="op">(</span><span class="va">lowresimagefile</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">##   format width height colorspace matte filesize density</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> JPEG     565    600 sRGB       FALSE   <span style="text-decoration: underline;">106</span>233 72x72</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert coordinates</span></span>
<span><span class="va">xy</span> <span class="op">&lt;-</span> <span class="va">xy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">pxl_col_in_fullres</span><span class="op">:</span><span class="va">pxl_row_in_fullres</span>, </span>
<span>                <span class="op">~</span> <span class="va">.x</span><span class="op">*</span><span class="va">scalefactors</span><span class="op">$</span><span class="va">tissue_lowres_scalef</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>There are a couple of important things to pay attention to here. The
x, y coordinates are now transformed to fit our H&amp;E image and
therefore we can set the limits of the plot to be the same as the
H&amp;E image dimensions (see <code>limits</code> in
<code>scale_*_continuous()</code>). We also need to set
<code>expand = c(0, 0)</code> to make sure that the margins are removed
from the plot area. We also need to invert the y axis which we can do
now that we have the H&amp;E image height
(<code>image_info(im)$height</code>).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">im</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.raster.html" class="external-link">rasterGrob</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">xy</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">pxl_col_in_fullres</span>, </span>
<span>               <span class="va">pxl_row_in_fullres</span>, </span>
<span>               color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotation_custom.html" class="external-link">annotation_custom</a></span><span class="op">(</span><span class="va">g</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="fl">0</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-10-1.png" width="864"></p>
<p>There are also functions available to apply transformations to spots:
<code><a href="../reference/CoordTransform.html">CoordTransform()</a></code> and <code><a href="../reference/CoordMirror.html">CoordMirror()</a></code>.</p>
<p><code>CoordTransform</code> is equivalent to
<code>ImageTransform</code> but for spot coordinates, meaning that you
can apply rotations and translations. The main difference is that
<code>CoordTransform</code> rotates around a predefined center. If you
want apply the same rotation to an H&amp;E image and its corresponding
spot coordinates, you want to set the <code>center</code> argument to be
the center of the H&amp;E image.</p>
<p>Let’s demonstrate this with our spot coordinates:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select only x, y coordinates</span></span>
<span><span class="va">xy_coords</span> <span class="op">&lt;-</span> <span class="va">xy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pxl_col_in_fullres</span>, <span class="va">pxl_row_in_fullres</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Midpoint</span></span>
<span><span class="va">c_xy</span> <span class="op">&lt;-</span> <span class="fu">colMeans</span><span class="op">(</span><span class="va">xy_coords</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply transformation to apot coordinates</span></span>
<span><span class="va">xy_transformed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CoordTransform.html">CoordTransform</a></span><span class="op">(</span><span class="va">xy_coords</span>, angle <span class="op">=</span> <span class="fl">45</span>, xy_offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot spot coordinates</span></span>
<span><span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">xy_coords</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"original"</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">xy_transformed</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"transformed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">gg</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">c_xy</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">c_xy</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"red"</span>, </span>
<span>             size <span class="op">=</span> <span class="fl">5</span>, shape <span class="op">=</span> <span class="fl">4</span>, stroke <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="op">~</span><span class="va">type</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="fl">0</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-11-1.png" width="864"></p>
<p>The spots are rotated around the center of our spots (red cross).
Instead, we want to define a center to rotate the spots around, which
will the the center of our H&amp;E image.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select only x, y coordinates</span></span>
<span><span class="va">xy_coords</span> <span class="op">&lt;-</span> <span class="va">xy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pxl_col_in_fullres</span>, <span class="va">pxl_row_in_fullres</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply transformation to apot coordinates</span></span>
<span><span class="va">xy_transformed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CoordTransform.html">CoordTransform</a></span><span class="op">(</span><span class="va">xy_coords</span>, angle <span class="op">=</span> <span class="fl">45</span>, xy_offset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>, </span>
<span>                                 center <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">width</span><span class="op">/</span><span class="fl">2</span>, </span>
<span>                                            <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot spot coordinates</span></span>
<span><span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">xy_coords</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"original"</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">xy_transformed</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"transformed"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">gg</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span>  <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">width</span><span class="op">/</span><span class="fl">2</span>, </span>
<span>                 y <span class="op">=</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, </span>
<span>             color <span class="op">=</span> <span class="st">"blue"</span>, size <span class="op">=</span> <span class="fl">5</span>, stroke <span class="op">=</span> <span class="fl">3</span>, shape <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="op">~</span><span class="va">type</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="fl">0</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-12-1.png" width="864"></p>
<p>Now let’s have a look at how we can transform coordinates and images
at the same time.</p>
</div>
<div class="section level2">
<h2 id="transform-images-and-spots">Transform images and spots<a class="anchor" aria-label="anchor" href="#transform-images-and-spots"></a>
</h2>
<div class="section level3">
<h3 id="rotation">Rotation<a class="anchor" aria-label="anchor" href="#rotation"></a>
</h3>
<p>The <code><a href="../reference/CoordAndImageTransform.html">CoordAndImageTransform()</a></code> makes the transformation
process a bit simpler. You can provide the H&amp;E image and its
corresponding spot coordinates and apply transformations to both objects
simultaneously. note that the spot coordinates are still defined the
same way as before, i.e. the origin is in the top left corner. This
means that we still need to invert the y axis.</p>
<p>Since some of the spots are now outside the “art board”, they will be
missed when drawing the plot. In this example, we lose 46 spots!</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select only x, y coordinates</span></span>
<span><span class="va">xy_coords</span> <span class="op">&lt;-</span> <span class="va">xy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pxl_col_in_fullres</span>, <span class="va">pxl_row_in_fullres</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply transformations</span></span>
<span><span class="va">transf_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CoordAndImageTransform.html">CoordAndImageTransform</a></span><span class="op">(</span><span class="va">im</span>, <span class="va">xy_coords</span>, angle <span class="op">=</span> <span class="fl">45</span>, xy_offset_image <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot results</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">transf_res</span><span class="op">$</span><span class="va">im_transf</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.raster.html" class="external-link">rasterGrob</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add selected to transf_res$xy_transf</span></span>
<span><span class="va">transf_res</span><span class="op">$</span><span class="va">xy_transf</span><span class="op">$</span><span class="va">selected</span> <span class="op">&lt;-</span> <span class="va">xy</span><span class="op">$</span><span class="va">selected</span></span>
<span></span>
<span><span class="co"># Note that the y axis still needs to be reversed</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">transf_res</span><span class="op">$</span><span class="va">xy_transf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">tr_x</span>, <span class="va">tr_y</span>, </span>
<span>               color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotation_custom.html" class="external-link">annotation_custom</a></span><span class="op">(</span><span class="va">g</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span>, <span class="fl">0</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-13-1.png" width="864"></p>
</div>
<div class="section level3">
<h3 id="rotation-translation">Rotation + translation<a class="anchor" aria-label="anchor" href="#rotation-translation"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select only x, y coordinates</span></span>
<span><span class="va">xy_coords</span> <span class="op">&lt;-</span> <span class="va">xy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pxl_col_in_fullres</span>, <span class="va">pxl_row_in_fullres</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply transformations</span></span>
<span><span class="va">transf.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CoordAndImageTransform.html">CoordAndImageTransform</a></span><span class="op">(</span><span class="va">im</span>, <span class="va">xy_coords</span>, angle <span class="op">=</span> <span class="fl">45</span>, xy_offset_image <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot results</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">transf.res</span><span class="op">$</span><span class="va">im_transf</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.raster.html" class="external-link">rasterGrob</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add selected to transf.res$xy_transf</span></span>
<span><span class="va">transf.res</span><span class="op">$</span><span class="va">xy_transf</span><span class="op">$</span><span class="va">selected</span> <span class="op">&lt;-</span> <span class="va">xy</span><span class="op">$</span><span class="va">selected</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">transf.res</span><span class="op">$</span><span class="va">xy_transf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">tr_x</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span> <span class="va">tr_y</span>, </span>
<span>               color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotation_custom.html" class="external-link">annotation_custom</a></span><span class="op">(</span><span class="va">g</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-14-1.png" width="864"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Select only x, y coordinates</span></span>
<span><span class="va">xy_coords</span> <span class="op">&lt;-</span> <span class="va">xy</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">pxl_col_in_fullres</span>, <span class="va">pxl_row_in_fullres</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply transformations</span></span>
<span><span class="va">transf.res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CoordAndImageTransform.html">CoordAndImageTransform</a></span><span class="op">(</span><span class="va">im</span>, <span class="va">xy_coords</span>, angle <span class="op">=</span> <span class="fl">45</span>, mirror_x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot results</span></span>
<span><span class="va">g</span> <span class="op">&lt;-</span> <span class="va">transf.res</span><span class="op">$</span><span class="va">im_transf</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/grid/grid.raster.html" class="external-link">rasterGrob</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"npc"</span><span class="op">)</span>, interpolate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add selected to transf.res$xy_transf</span></span>
<span><span class="va">transf.res</span><span class="op">$</span><span class="va">xy_transf</span><span class="op">$</span><span class="va">selected</span> <span class="op">&lt;-</span> <span class="va">xy</span><span class="op">$</span><span class="va">selected</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">transf.res</span><span class="op">$</span><span class="va">xy_transf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">tr_x</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span> <span class="op">-</span> <span class="va">tr_y</span>, </span>
<span>               color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">selected</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotation_custom.html" class="external-link">annotation_custom</a></span><span class="op">(</span><span class="va">g</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="cn">Inf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">width</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://docs.ropensci.org/magick/reference/attributes.html" class="external-link">image_info</a></span><span class="op">(</span><span class="va">im</span><span class="op">)</span><span class="op">$</span><span class="va">height</span><span class="op">)</span>, expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="images_and_coordinates_files/figure-html/unnamed-chunk-15-1.png" width="864"></p>
<p><br></p>
<hr>
<details open><summary><strong>Package versions</strong>
</summary><ul>
<li><p><code>semla</code>: 1.0.0</p></li>
<li><p><code>magick</code>: 2.7.3</p></li>
</ul></details><details><summary><strong>Session info</strong>
</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.2.1 (2022-06-23)</span></span>
<span><span class="co">## Platform: x86_64-apple-darwin13.4.0 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Big Sur ... 10.16</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS/LAPACK: /Users/ludviglarsson/miniconda3/envs/R4.2/lib/libopenblasp-r0.3.21.dylib</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] grid      stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">## [1] jsonlite_1.8.3     magick_2.7.3       semla_1.0.0        ggplot2_3.4.1     </span></span>
<span><span class="co">## [5] dplyr_1.1.0        SeuratObject_4.1.3 Seurat_4.3.0      </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] Rtsne_0.16             colorspace_2.0-3       deldir_1.0-6          </span></span>
<span><span class="co">##   [4] ellipsis_0.3.2         ggridges_0.5.3         rprojroot_2.0.3       </span></span>
<span><span class="co">##   [7] fs_1.5.2               spatstat.data_3.0-0    rstudioapi_0.14       </span></span>
<span><span class="co">##  [10] farver_2.1.1           leiden_0.4.2           listenv_0.8.0         </span></span>
<span><span class="co">##  [13] ggrepel_0.9.3          fansi_1.0.3            codetools_0.2-18      </span></span>
<span><span class="co">##  [16] splines_4.2.1          cachem_1.0.6           knitr_1.39            </span></span>
<span><span class="co">##  [19] zeallot_0.1.0          polyclip_1.10-0        ica_1.0-3             </span></span>
<span><span class="co">##  [22] cluster_2.1.4          png_0.1-7              uwot_0.1.14           </span></span>
<span><span class="co">##  [25] spatstat.sparse_3.0-0  shiny_1.7.4            sctransform_0.3.5     </span></span>
<span><span class="co">##  [28] compiler_4.2.1         httr_1.4.4             Matrix_1.5-3          </span></span>
<span><span class="co">##  [31] fastmap_1.1.0          lazyeval_0.2.2         cli_3.4.1             </span></span>
<span><span class="co">##  [34] later_1.3.0            htmltools_0.5.4        tools_4.2.1           </span></span>
<span><span class="co">##  [37] igraph_1.3.4           gtable_0.3.0           glue_1.6.2            </span></span>
<span><span class="co">##  [40] RANN_2.6.1             reshape2_1.4.4         Rcpp_1.0.9            </span></span>
<span><span class="co">##  [43] scattermore_0.8        jquerylib_0.1.4        pkgdown_2.0.6         </span></span>
<span><span class="co">##  [46] vctrs_0.5.2            nlme_3.1-159           spatstat.explore_3.0-5</span></span>
<span><span class="co">##  [49] progressr_0.10.1       lmtest_0.9-40          spatstat.random_3.0-1 </span></span>
<span><span class="co">##  [52] xfun_0.32              stringr_1.5.0          globals_0.16.0        </span></span>
<span><span class="co">##  [55] mime_0.12              miniUI_0.1.1.1         lifecycle_1.0.3       </span></span>
<span><span class="co">##  [58] irlba_2.3.5            goftest_1.2-3          future_1.27.0         </span></span>
<span><span class="co">##  [61] MASS_7.3-58.1          zoo_1.8-10             scales_1.2.1          </span></span>
<span><span class="co">##  [64] ragg_1.2.2             promises_1.2.0.1       spatstat.utils_3.0-1  </span></span>
<span><span class="co">##  [67] parallel_4.2.1         RColorBrewer_1.1-3     curl_4.3.2            </span></span>
<span><span class="co">##  [70] yaml_2.3.5             memoise_2.0.1          reticulate_1.26       </span></span>
<span><span class="co">##  [73] pbapply_1.5-0          gridExtra_2.3          sass_0.4.2            </span></span>
<span><span class="co">##  [76] stringi_1.7.8          highr_0.9              desc_1.4.1            </span></span>
<span><span class="co">##  [79] rlang_1.0.6            pkgconfig_2.0.3        systemfonts_1.0.4     </span></span>
<span><span class="co">##  [82] matrixStats_0.62.0     evaluate_0.16          lattice_0.20-45       </span></span>
<span><span class="co">##  [85] tensor_1.5             ROCR_1.0-11            purrr_1.0.1           </span></span>
<span><span class="co">##  [88] labeling_0.4.2         patchwork_1.1.2        htmlwidgets_1.5.4     </span></span>
<span><span class="co">##  [91] cowplot_1.1.1          tidyselect_1.2.0       parallelly_1.32.1     </span></span>
<span><span class="co">##  [94] RcppAnnoy_0.0.19       plyr_1.8.7             magrittr_2.0.3        </span></span>
<span><span class="co">##  [97] R6_2.5.1               generics_0.1.3         withr_2.5.0           </span></span>
<span><span class="co">## [100] pillar_1.8.1           fitdistrplus_1.1-8     abind_1.4-5           </span></span>
<span><span class="co">## [103] survival_3.4-0         sp_1.5-1               tibble_3.1.8          </span></span>
<span><span class="co">## [106] future.apply_1.9.0     KernSmooth_2.23-20     utf8_1.2.2            </span></span>
<span><span class="co">## [109] spatstat.geom_3.0-3    plotly_4.10.0          rmarkdown_2.15        </span></span>
<span><span class="co">## [112] data.table_1.14.2      forcats_0.5.2          digest_0.6.29         </span></span>
<span><span class="co">## [115] xtable_1.8-4           dbscan_1.1-10          tidyr_1.3.0           </span></span>
<span><span class="co">## [118] httpuv_1.6.5           textshaping_0.3.6      munsell_0.5.0         </span></span>
<span><span class="co">## [121] viridisLite_0.4.1      bslib_0.4.0            shinyjs_2.1.0</span></span></code></pre>
</details><p><br></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/ludvigla" class="external-link">Ludvig Larsson</a>, <a href="https://github.com/lfranzen" class="external-link">Lovisa Franzen</a>, <a href="https://www.spatialresearch.org/" class="external-link"><img src="reference/figures/sr-logo.png" height="36" alt="spatialresearch"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
